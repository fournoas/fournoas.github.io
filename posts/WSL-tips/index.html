<!doctype html><html lang=zh-CN><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Windows Subsystem for Linux 是 Windows 上运行 Linux 环境的兼容层。WSL 有两个版本，分别是 WSL 1 和 WSL 2，后者现在是 Windows 默认安装的版本。两个版本在底层实现上有很大区别，WSL 1 通过 lxss.sys 和 lxcore.sys 这两个 Windows 内核驱动来模拟 Linux 内核，而 WSL 2 通过 Hyper-V 虚拟机托管运行了一个经过优化过的 Linux 内核，能够提供完整的 Linux 系统调用，并支持 systemd 和 IPv6。缺点"><title>WSL 使用技巧 &#183; 白汤四物</title>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/fontawesome.min.css crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/solid.min.css crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/regular.min.css crossorigin=anonymous referrerpolicy=no-referrer><script src=https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js crossorigin=anonymous></script><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/rainbow.min.css crossorigin=anonymous referrerpolicy=no-referrer><link href rel=alternate type=application/rss+xml title=白汤四物><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-3GNL63B62Q"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3GNL63B62Q")</script></head><body><nav class=nav><div class=nav-container><h1 class=nav-title><a href=/><img src=/logo.png alt=白汤四物></a></h1><ul><li><a href=/posts/><span>文章</span></a></li><li><a href=/moments/><span>动态</span></a></li><li><a href=/categories/><span>分类</span></a></li><li><a href=/tags/><span>标签</span></a></li><li><a href=/search/><span>搜索</span></a></li><li><a href=/about/><span>关于</span></a></li></ul></div></nav><main data-pagefind-body><div class="page post"><h1 class=post-title data-pagefind-meta=title>WSL 使用技巧</h1><div class=post-line></div><div class=post-info><span>作者</span>
<span data-pagefind-meta=作者>Fournoas
</span><span>于&nbsp;</span><time datetime="2024-03-15 00:00:00 +0000 UTC" data-pagefind-meta=日期>2024年3月15日</time>
<span>发布在&nbsp;</span><ul class=categories><li><a data-pagefind-filter=分类 href=/categories/using/>Using</a></li></ul></div><nav id=TableOfContents><ul><li><a href=#wsl-命令>WSL 命令</a><ul><li><a href=#以指定用户身份运行-wsl>以指定用户身份运行 WSL</a></li><li><a href=#windows-下运行-linux-命令>Windows 下运行 Linux 命令</a></li><li><a href=#终止正在运行的-wsl>终止正在运行的 WSL</a></li></ul></li><li><a href=#互相访问文件系统>互相访问文件系统</a></li><li><a href=#wsl-配置文件>WSL 配置文件</a></li><li><a href=#启用-systemd>启用 systemd</a></li><li><a href=#禁止-wsl-和-windows-交互>禁止 WSL 和 Windows 交互</a></li><li><a href=#共享环境变量>共享环境变量</a></li><li><a href=#网络设置>网络设置</a><ul><li><a href=#启用镜像网络模式>启用「镜像」网络模式</a></li><li><a href=#nat-模式下的-wsl-和-windows-网络>NAT 模式下的 WSL 和 Windows 网络</a></li><li><a href=#为-wsl-设置代理>为 WSL 设置代理</a></li></ul></li><li><a href=#运行-linux-gui-程序>运行 Linux GUI 程序</a></li><li><a href=#迁移-wsl-发行版镜像文件>迁移 WSL 发行版镜像文件</a></li><li><a href=#vscode-远程开发扩展包>VSCode 远程开发扩展包</a></li></ul></nav><div id=collapsed-toc><a class=button><i class="fa-solid fa-bars"></i></a></div><aside id=aside-toc data-pagefind-ignore><div class=header><i class="fa-solid fa-bars"></i>&nbsp;章节目录<a class="button close"><i class="fa-solid fa-xmark"></i></a></div><div class=content></div></aside><p>Windows Subsystem for Linux 是 Windows 上运行 Linux 环境的兼容层。WSL 有两个版本，分别是 WSL 1 和 WSL 2，后者现在是 Windows 默认安装的版本。两个版本在底层实现上有很大区别，WSL 1 通过 <em>lxss.sys</em> 和 <em>lxcore.sys</em> 这两个 Windows 内核驱动来模拟 Linux 内核，而 WSL 2 通过 Hyper-V 虚拟机托管运行了一个经过优化过的 Linux 内核，能够提供完整的 Linux 系统调用，并支持 systemd 和 IPv6。缺点是跨系统的文件系统访问性能比 WSL 1 差很多（但 WSL 2 的文件 IO 性能比 WSL 1 的更好）。因此，<strong>当使用 WSL 作为开发环境时，建议不要将源代码存放在 Windows 的文件系统下</strong>。</p><p>WSL 2 的其他问题有：</p><ul><li>WSL 2 不支持访问串口</li><li>WSL 2 通过 NAT 来访问网络，而不是和 Windows 宿主使用同一个网络接口（新版本可以启用网络镜像模式）</li><li>WSL 2 访问 USB 端口需要安装 <a href=https://github.com/dorssel/usbipd-win target=_blank rel=noopener>usbipd-win</a></li></ul><h2 id=wsl-命令>WSL 命令</h2><p>通过 <code>wsl</code> 命令可以启动进入 WSL 环境；通过 <code>wsl --install</code> 命令可以从 WSL 1 升级到 WSL 2；还可以通过 <code>wsl --set-verion</code> 命令在 WSL 1和 WSL 2 版本间切换；使用 <code>wsl --update</code> 用于更新 WSL 版本；通过 <code>wsl -l --all -v</code> 查看所有 WSL 发行版及其状态。</p><p>除了以上这些常用命令，还有如下的一些不常用但比较实用的命令：</p><h3 id=以指定用户身份运行-wsl>以指定用户身份运行 WSL</h3><p>通过参数 <code>-u</code> 可以指定运行 WSL 的用户身份。比如要以 root 身份来运行 WSL：</p><pre><span class=code-lang>POWERSHELL</span><code class=language-powershell>wsl -u root</code></pre><h3 id=windows-下运行-linux-命令>Windows 下运行 Linux 命令</h3><p>可以使用 <code>wsl &lt;linux command></code> 来运行 Linux 命令。例如可以用如下命令来运行带参数的 Linux Shell 命令 <code>ls -al</code>：</p><pre><span class=code-lang>POWERSHELL</span><code class=language-powershell>wsl ls -al</code></pre><p>可以使用 <code>-u</code> 搭配 <code>--</code> 参数，以指定用户身份运行 Linux 命令。例如：</p><pre><span class=code-lang>POWERSHELL</span><code class=language-powershell>wsl -u root -- apt update</code></pre><h3 id=终止正在运行的-wsl>终止正在运行的 WSL</h3><p>终止所有正在运行的发行版和 WSL 2：</p><pre><span class=code-lang>POWERSHELL</span><code class=language-powershell>wsl --shutdown</code></pre><p>终止指定的分发版：</p><pre><span class=code-lang>POWERSHELL</span><code class=language-powershell>wsl -t &lt;Distro&gt;</code></pre><p>其中 <code>Distro</code> 是发行版名称，比如 <code>wsl -t Ubuntu</code>。</p><h2 id=互相访问文件系统>互相访问文件系统</h2><p>在 Windows 中访问 Linux 文件系统的路径为：</p><pre><code class=language-text>\\wsl$\&lt;Distro&gt;\</code></pre><p>或者</p><pre><code class=language-text>\\wsl.localhost\&lt;Distro&gt;\</code></pre><p>其中 <code>Distro</code> 是发行版名称，比如 <code>\\wsl$\Ubuntu\</code> 或者 <code>\\wsl.localhost\Ubuntu\</code>。</p><p>在 Linux 中访问 Windows 文件系统的路径为：</p><pre><code class=language-text>/mnt/&lt;Drive&gt;/</code></pre><p>其中 <code>Drive</code> 是 Windows 的盘符，比如 <code>/mnt/c/</code> 或者 <code>/mnt/d/</code>。通过 <code>mount</code> 命令可以得知，在 WSL 2 中， <code>/mnt/c/</code> 的文件类型为 <a href=https://www.kernel.org/doc/Documentation/filesystems/9p.txt target=_blank rel=noopener>9p</a>：</p><pre><code class=language-text>C:\ on /mnt/c type 9p (rw,noatime,dirsync,aname=drvfs;path=C:\;uid=1000;gid=1000;symlinkroot=/mnt/,mmap,access=client,msize=65536,trans=fd,rfd=5,wfd=5)</code></pre><p>不同于 WSL 1 的 drvfs，9pfs 是一种远程文件协议。这也解释了为什么 WSL 2 中，访问 Windows 文件系统的性能会比较差了。</p><h2 id=wsl-配置文件>WSL 配置文件</h2><p>WSL 的配置文件有两处，分别是：</p><ol><li>Linux 系统下的 /etc/wsl.conf</li><li>Windows 系统下的 %UserProfile%\.wslconfig</li></ol><p><em>wsl.conf</em> 仅对当前 Linux 系统生效；<em>.wslconfig</em> 作用范围是全局，但仅有 WSL 2 支持该配置文件。</p><p>修改配置文件后，需要重启 WSL 实例使得修改生效：</p><pre><span class=code-lang>POWERSHELL</span><code class=language-powershell>wsl --shutdown &amp;&amp; wsl</code></pre><p>更多的配置信息可以参考：<a href=https://learn.microsoft.com/zh-cn/windows/wsl/wsl-config target=_blank rel=noopener>https://learn.microsoft.com/zh-cn/windows/wsl/wsl-config</a></p><h2 id=启用-systemd>启用 systemd</h2><p>在 WSL 配置文件中添加如下内容：</p><pre><span class=code-lang>INI</span><code class=language-ini>[boot]
systemd = true</code></pre><h2 id=禁止-wsl-和-windows-交互>禁止 WSL 和 Windows 交互</h2><p>默认情况下，WSL 中可以执行 Windows 程序。其底层利用 binfmt_misc 实现：当 Linux 执行 PE 文件时，匹配到 <code>magic 4d5a</code> ，会交给 <em>/init</em> 运行。事实上，WSL 中执行的 Windows 程序，最终是都在 Windows 系统中执行的。而 <em>/init</em> 会和宿主 Windows 系统进行交互，传递执行参数并将执行结果返回到 WSL 中。</p><p>此外，WSL 还会将 Windows 环境变量 PATH 中的路径添加到 Linux 的 path 环境变量中。如果 Linux 系统和 Windows 系统中有相同文件名的可执行文件，这一特性某些情况下会导致冲突，在前文《<a href=./running-lazarus-ide-in-wsl/>在 WSL 中运行 Lazarus IDE</a>》中描述了这个问题。</p><p>在 WSL 配置文件中添加如下内容：</p><pre><span class=code-lang>INI</span><code class=language-ini>[interop]
enable = false # 关闭执行 Windows 程序的功能
appendWindowsPath = false # 不允许添加 Windows 的可执行路径到 path 中</code></pre><p>通过下面的命令可以在当前会话中临时关闭执行 Windows 程序的功能：</p><pre><span class=code-lang>SHELL</span><code class=language-shell>echo 0 &gt; /proc/sys/fs/binfmt_misc/WSLInterop</code></pre><p>通过下面的命令开启：</p><pre><span class=code-lang>SHELL</span><code class=language-shell>echo 1 &gt; /proc/sys/fs/binfmt_misc/WSLInterop</code></pre><h2 id=共享环境变量>共享环境变量</h2><p>WSL 和 Windows 共享一个名为 <code>WSLENV</code> 的特殊环境变量，其值保存着需要在 WSL 和 Windows 之间共享的环境变量列表。列表的规则如下：</p><ul><li>环境变量列表由冒号分隔</li><li>每个变量可以跟随一个斜杠分隔的标志，含义如下：<ul><li><code>/p</code> - 在 WSL/Linux 样式路径与 Win32 路径之间转换路径。</li><li><code>/l</code> - 指示环境变量是路径列表。</li><li><code>/u</code> - 指示仅当从 Win32 运行 WSL 时，才应包含此环境变量。</li><li><code>/w</code> - 指示仅当从 WSL 运行 Win32 时，才应包含此环境变量。</li></ul></li><li>如果环境变量值是路径列表，在 WSL 中，列表应由冒号分隔；在 Windows 中，列表应由分号分隔</li><li>可以在 <em>~/.bashrc</em> 中或者 Windows 环境中设置 WSLENV</li></ul><p>比如，我们需要在 WSL 中使用 Windows 的环境变量 <code>JAVA_HOME</code>，可以在 Windows 中如下操作：</p><pre><span class=code-lang>POWERSHELL</span><code class=language-powershell>$ENV:WSLENV &#43;= &#39;:JAVA_HOME/p&#39;</code></pre><p>假设 Windows 下的 <code>JAVA_HOME</code> 值为 <code>C:\jre</code>，则 WSL 中 <code>JAVA_HOME</code> 值会自动转换为 <code>/mnt/c/jre</code>。</p><h2 id=网络设置>网络设置</h2><p>WSL 1 使用和 Windows 共用相同的网络接口，WSL 和 Windows 应用之间可视作本机访问。而 WSL 2 底层为托管虚拟机，因此存在跨主机网络访问的问题。默认情况下，WSL 2 使用 NAT 模式的网络结构。对 Windows 11 版本 22H2 以上的系统，可以开启网络镜像模式。此模式下，会将 Windows 下的网络接口「镜像」到 WSL 的 Linux 环境中。</p><h3 id=启用镜像网络模式>启用「镜像」网络模式</h3><p>在 WSL 全局配置文件 <em>.wslconfig</em> 中添加以下内容：</p><pre><span class=code-lang>INI</span><code class=language-ini>[wsl2]
networkingMode = mirrored
dnsTunneling = true
firewall = true</code></pre><h3 id=nat-模式下的-wsl-和-windows-网络>NAT 模式下的 WSL 和 Windows 网络</h3><p>在 NAT 模式下，Linux 系统默认使用动态 IP。不过当 Linux 进程绑定端口时，WSL 会将端口映射到 Windows 中。底层是通过 <em>wslrelay.exe</em> 进程实现了端口转发。因此，Windows 下可以通过本机端口来访问 WSL 下的网络端口。通常情况下，我们而不需要获取 Linux 主机的 IP 地址。WSL 下可以通过下面的命令来获取 Linux 主机的 IP 地址：</p><pre><span class=code-lang>SHELL</span><code class=language-shell>hostname -I</code></pre><p>Windows 下则是：</p><pre><span class=code-lang>POWERSHELL</span><code class=language-powershell>wsl hostname -I</code></pre><p>而在 WSL 下要访问 Windows 主机则需要通过 IP 地址。在 Windows 中，可以查看网络适配器 &ldquo;vEthernet (WSL)&rdquo; 的 IPv4 地址来获得 Windows 主机的 IP。在 Linux 环境中，也可以通过下面的命令来获取 Windows 主机的 IP：</p><pre><span class=code-lang>SHELL</span><code class=language-shell>ip route show | grep -i default | awk &#39;{ print $3}&#39;</code></pre><p>需要注意的是，在没有开启镜像模式的 WSL 2 环境中，使用 localhost 地址是无法访问到 Windows 网络服务的。 另外，必须正确设置 Windows 防火墙，才能让 WSL 2 下的 Linux 进程能够访问到 Windows 主机的端口。参见：<a href=https://github.com/microsoft/WSL/issues/4585 target=_blank rel=noopener>Add &ldquo;allow&rdquo; rule to Windows firewall for WSL2 network · Issue #4585</a>。</p><h3 id=为-wsl-设置代理>为 WSL 设置代理</h3><p>对于 Windows 11 操作系统，可以在 WSL 全局配置文件 <em>.wslconfig</em> 中添加以下内容，让 WSL 使用 Windows 的系统代理服务器设置：</p><pre><span class=code-lang>INI</span><code class=language-ini>[wsl2]
autoProxy = true</code></pre><p>如果是 Windows 10 操作系统，则需要手动设置代理服务器：</p><pre><span class=code-lang>SHELL</span><code class=language-shell>export http_proxy=&lt;Proxy&gt;
export https_proxy=&lt;Proxy&gt;</code></pre><p>记得一定要在 Windows 中新增一条防火墙规则，允许来自 WSL 的网络访问本地代理服务器端口。以管理员权限在 Windows 下运行以下命令（以本地代理服务端口是 7890 为例）：</p><pre><span class=code-lang>POWERSHELL</span><code class=language-powershell>New-NetFirewallRule -DisplayName &#34;Local Proxy&#34; -Direction Inbound -Protocol TCP -LocalPort 7890  -Action Allow</code></pre><h2 id=运行-linux-gui-程序>运行 Linux GUI 程序</h2><p>WSL 自带 WSLg X Server，可以让 WSL 中的 GUI 应用直接在 Windows 中进行渲染，其底层服务由 <em>msrdc.exe</em> 进程提供。你也可以使用其他第三方 X Server 服务，比如 MobaXterm 自带的 X Server。</p><h2 id=迁移-wsl-发行版镜像文件>迁移 WSL 发行版镜像文件</h2><p>WSL 发行版默认安装路径是 <em>%UserProfile%\AppData\Local\Packages\&lt;发行版名称></em> 下，发行版镜像文件则保存在安装路径下的 <em>LocalState\ext4.vhdx</em> 文件中。可以使用下面的命令将镜像文件迁移到其他路径（此处以 <em>D:\WSL\Ubuntu.vhdx</em> 为例）：</p><pre><span class=code-lang>POWERSHELL</span><code class=language-powershell>wsl --shutdown
wsl --export Ubuntu D:\WSL\Ubuntu.vhdx --vhd
wsl --unregister Ubuntu
wsl --import-in-place Ubuntu D:\WSL\Ubuntu.vhdx</code></pre><p>重新导入后，WSL 会以 root 用户身份登录，可以重新设置默认登录用户：</p><pre><span class=code-lang>POWERSHELL</span><code class=language-powershell>ubuntu config --default-user &lt;YourUserName&gt;</code></pre><h2 id=vscode-远程开发扩展包>VSCode 远程开发扩展包</h2><p>安装 <a href="https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.vscode-remote-extensionpack" target=_blank rel=noopener>Remote Development</a> 扩展包，让 VSCode 支持使用 WSL 开发环境。有两种方法可以启动远程开发：</p><ol><li>在 WSL 命令行下，运行命令：<pre><span class=code-lang>SHELL</span><code class=language-shell>code ~\myproject</code></pre></li><li>在 VSCode 中用 Ctrl+Shift+P 打开命令面板，输入 <code>WSL</code>，点击 <code>WSL: Connect to WSL</code></li></ol><p>方法一需要开启 WSL 和 Windows 交互功能。</p></div><div class=taxonomy data-pagefind-ignore><div class=taxonomy-tags><ul class=tags><li>#<a data-pagefind-filter=标签 href=/tags/WSL/>WSL</a></li></ul></div></div><div class=pagination data-pagefind-ignore><a href=/moments/202403/1709869113/ class="right arrow">下一篇</a>
<a href=# class=top>返回顶部</a></div></main><script src=/js/page.js></script><script src=/js/main.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/scala.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/nim.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/powershell.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/nginx.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/delphi.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/dos.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/haxe.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=/js/code.js></script><script>hljs.highlightAll(),hljs.initLineNumbersOnLoad(),hljs.initSelectLines()</script><footer><span>&copy; <time datetime="2024-03-18 08:44:30.979081776 +0000 UTC m=+0.828167450">2024</time> fournoas.com. Powered by <a href=https://gohugo.io>Hugo</a>.</span></footer></body></html>