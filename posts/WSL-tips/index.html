<!doctype html><html lang=zh-CN><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Windows Subsystem for Linux 是 Windows 上运行 Linux 环境的兼容层。WSL 有两个版本，分别是 WSL 1 和 WSL 2，后者现在是 Windows 默认安装的版本。两个版本在底层实现上有很大区别，WSL 1 通过 lxss.sys 和 lxcore.sys 这两个 Windows 内核驱动来模拟 Linux 内核，而 WSL 2 通过 Hyper-V 虚拟机托管运行了一个经过优化过的 Linux 内核，能够提供完整的 Linux 系统调用，并支持 systemd 和 IPv6。缺点是跨系统的文件系统访问性能比 WSL 1 差很多（但 WSL 2 的文件 IO 性能比 WSL 1 的更好）。因此，当使用 WSL 作为开发环境时，建议不要将源代码存放在 Windows 的文件系统下。"><title>WSL 使用技巧 &#183; 白汤四物</title>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/fontawesome.min.css crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/solid.min.css crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/regular.min.css crossorigin=anonymous referrerpolicy=no-referrer><script src=https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js crossorigin=anonymous></script><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/styles/rainbow.min.css crossorigin=anonymous referrerpolicy=no-referrer><link href rel=alternate type=application/rss+xml title=白汤四物><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-3GNL63B62Q"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3GNL63B62Q")</script></head><body><nav class=nav><div class=nav-container><h1 class=nav-title><a href=/><img src=/logo.png alt=白汤四物></a></h1><ul><li><a href=/posts/><span>文章</span></a></li><li><a href=/moments/><span>动态</span></a></li><li><a href=/categories/><span>分类</span></a></li><li><a href=/tags/><span>标签</span></a></li><li><a href=/search/><span>搜索</span></a></li><li><a href=/about/><span>关于</span></a></li></ul></div></nav><main data-pagefind-body><div class="page post"><h1 class=post-title data-pagefind-meta=title>WSL 使用技巧</h1><div class=post-line></div><div class=post-info><span>作者</span>
<span data-pagefind-meta=作者>Fournoas
</span><span>写于&nbsp;</span><time datetime="2024-03-15 00:00:00 +0000 UTC" data-pagefind-meta=日期>2024年3月15日</time>
<span>发布在&nbsp;</span><ul class=categories><li><a data-pagefind-filter=分类 href=/categories/using/>Using</a></li></ul></div><nav id=TableOfContents><ul><li><a href=#wsl-命令>WSL 命令</a><ul><li><a href=#以指定用户身份运行-wsl>以指定用户身份运行 WSL</a></li><li><a href=#windows-下运行-linux-命令>Windows 下运行 Linux 命令</a></li><li><a href=#终止正在运行的-wsl>终止正在运行的 WSL</a></li><li><a href=#解决升级-wsl-时出错>解决升级 WSL 时出错</a></li></ul></li><li><a href=#互相访问文件系统>互相访问文件系统</a></li><li><a href=#wsl-配置文件>WSL 配置文件</a></li><li><a href=#启用-systemd>启用 systemd</a></li><li><a href=#禁止-wsl-和-windows-交互>禁止 WSL 和 Windows 交互</a></li><li><a href=#共享环境变量>共享环境变量</a></li><li><a href=#网络设置>网络设置</a><ul><li><a href=#启用镜像网络模式>启用「镜像」网络模式</a></li><li><a href=#nat-模式下的-wsl-和-windows-网络>NAT 模式下的 WSL 和 Windows 网络</a></li><li><a href=#为-wsl-设置代理>为 WSL 设置代理</a></li></ul></li><li><a href=#迁移-wsl-发行版镜像文件>迁移 WSL 发行版镜像文件</a></li><li><a href=#vscode-远程开发扩展包>VSCode 远程开发扩展包</a></li><li><a href=#配置中文环境>配置中文环境</a></li><li><a href=#运行-linux-gui-程序>运行 Linux GUI 程序</a><ul><li><a href=#安装中文字体>安装中文字体</a></li><li><a href=#安装中文输入法>安装中文输入法</a></li><li><a href=#kde-应用图标丢失>KDE 应用图标丢失</a></li><li><a href=#修复-qtqpaxcb-could-not-connect-to-display>修复 &ldquo;qt.qpa.xcb: could not connect to display&rdquo;</a></li></ul></li><li><a href=#升级-ubuntu>升级 Ubuntu</a></li></ul></nav><div id=collapsed-toc><a class=button><i class="fa-solid fa-bars"></i></a></div><aside id=aside-toc data-pagefind-ignore><div class=header><i class="fa-solid fa-bars"></i>&nbsp;章节目录<a class="button close"><i class="fa-solid fa-xmark"></i></a></div><div class=content></div></aside><p>Windows Subsystem for Linux 是 Windows 上运行 Linux 环境的兼容层。WSL 有两个版本，分别是 WSL 1 和 WSL 2，后者现在是 Windows 默认安装的版本。两个版本在底层实现上有很大区别，WSL 1 通过 <em>lxss.sys</em> 和 <em>lxcore.sys</em> 这两个 Windows 内核驱动来模拟 Linux 内核，而 WSL 2 通过 Hyper-V 虚拟机托管运行了一个经过优化过的 Linux 内核，能够提供完整的 Linux 系统调用，并支持 systemd 和 IPv6。缺点是跨系统的文件系统访问性能比 WSL 1 差很多（但 WSL 2 的文件 IO 性能比 WSL 1 的更好）。因此，<strong>当使用 WSL 作为开发环境时，建议不要将源代码存放在 Windows 的文件系统下</strong>。</p><p>WSL 2 的其他问题有：</p><ul><li>WSL 2 不支持访问串口</li><li>WSL 2 通过 NAT 来访问网络，而不是和 Windows 宿主使用同一个网络接口（新版本可以启用网络镜像模式）</li><li>WSL 2 访问 USB 端口需要安装 <a href=https://github.com/dorssel/usbipd-win target=_blank rel=noopener>usbipd-win</a></li></ul><p>本文使用的 WSL 环境如下：</p><pre><code class=language-text>WSL 版本： 2.1.5.0
内核版本： 5.15.146.1-2
WSLg 版本： 1.0.60
MSRDC 版本： 1.2.5105
Direct3D 版本： 1.611.1-81528511
DXCore 版本： 10.0.25131.1002-220531-1700.rs-onecore-base2-hyp
Windows 版本： 10.0.19045.4170</code></pre><h2 id=wsl-命令>WSL 命令</h2><p>通过 <code>wsl</code> 命令可以启动进入 WSL 环境；通过 <code>wsl --install</code> 命令可以从 WSL 1 升级到 WSL 2；还可以通过 <code>wsl --set-verion</code> 命令在 WSL 1和 WSL 2 版本间切换；使用 <code>wsl --update</code> 用于更新 WSL 版本；通过 <code>wsl -l --all -v</code> 查看所有 WSL 发行版及其状态。</p><p>除了以上这些常用命令，还有如下的一些不常用但比较实用的命令：</p><h3 id=以指定用户身份运行-wsl>以指定用户身份运行 WSL</h3><p>通过参数 <code>-u</code> 可以指定运行 WSL 的用户身份。比如要以 root 身份来运行 WSL：</p><pre><span class=code-lang>powershell</span><code class=language-powershell>wsl -u root</code></pre><h3 id=windows-下运行-linux-命令>Windows 下运行 Linux 命令</h3><p>可以使用 <code>wsl &lt;linux command></code> 来运行 Linux 命令。例如可以用如下命令来运行带参数的 Linux Shell 命令 <code>ls -al</code>：</p><pre><span class=code-lang>powershell</span><code class=language-powershell>wsl ls -al</code></pre><p>可以使用 <code>-u</code> 搭配 <code>--</code> 参数，以指定用户身份运行 Linux 命令。例如：</p><pre><span class=code-lang>powershell</span><code class=language-powershell>wsl -u root -- apt update</code></pre><h3 id=终止正在运行的-wsl>终止正在运行的 WSL</h3><p>终止所有正在运行的发行版和 WSL 2：</p><pre><span class=code-lang>powershell</span><code class=language-powershell>wsl --shutdown</code></pre><p>终止指定的分发版：</p><pre><span class=code-lang>powershell</span><code class=language-powershell>wsl -t &lt;Distro&gt;</code></pre><p>其中 <code>Distro</code> 是发行版名称，比如 <code>wsl -t Ubuntu</code>。</p><h3 id=解决升级-wsl-时出错>解决升级 WSL 时出错</h3><p>有时运行 <code>wsl --update</code> 会抛出错误导致升级失败。可以从 <a href=https://github.com/microsoft/WSL/releases/ target=_blank rel=noopener>https://github.com/microsoft/WSL/releases/</a> 下载 WSL 最新版本的安装文件，进行手动安装升级。在安装过程中会弹出对话框提示错误，只要点击忽略继续完成安装即可。</p><p>比如我在升级时提示 <strong>Wsl/CallMsi/REGDB_E_CLASSNOTREG</strong> 错误。最后发现是因为删除注册表中涉及 WSL 资源管理器右键菜单的分支导致的。</p><h2 id=互相访问文件系统>互相访问文件系统</h2><p>在 Windows 中访问 Linux 文件系统的路径为：</p><pre><code class=language-text>\\wsl$\&lt;Distro&gt;\</code></pre><p>或者</p><pre><code class=language-text>\\wsl.localhost\&lt;Distro&gt;\</code></pre><p>其中 <code>Distro</code> 是发行版名称，比如 <code>\\wsl$\Ubuntu\</code> 或者 <code>\\wsl.localhost\Ubuntu\</code>。</p><p>在 Linux 中访问 Windows 文件系统的路径为：</p><pre><code class=language-text>/mnt/&lt;Drive&gt;/</code></pre><p>其中 <code>Drive</code> 是 Windows 的盘符，比如 <code>/mnt/c/</code> 或者 <code>/mnt/d/</code>。通过 <code>mount</code> 命令可以得知，在 WSL 2 中， <code>/mnt/c/</code> 的文件类型为 <a href=https://www.kernel.org/doc/Documentation/filesystems/9p.txt target=_blank rel=noopener>9p</a>：</p><pre><code class=language-text>C:\ on /mnt/c type 9p (rw,noatime,dirsync,aname=drvfs;path=C:\;uid=1000;gid=1000;symlinkroot=/mnt/,mmap,access=client,msize=65536,trans=fd,rfd=5,wfd=5)</code></pre><p>不同于 WSL 1 的 drvfs，9pfs 是一种远程文件协议。这也解释了为什么 WSL 2 中，访问 Windows 文件系统的性能会比较差了。</p><h2 id=wsl-配置文件>WSL 配置文件</h2><p>WSL 的配置文件有两处，分别是：</p><ol><li>Linux 系统下的 /etc/wsl.conf</li><li>Windows 系统下的 %UserProfile%\.wslconfig</li></ol><p><em>wsl.conf</em> 仅对当前 Linux 系统生效；<em>.wslconfig</em> 作用范围是全局，但仅有 WSL 2 支持该配置文件。</p><p>修改配置文件后，需要重启 WSL 实例使得修改生效：</p><pre><span class=code-lang>powershell</span><code class=language-powershell>wsl --shutdown &amp;&amp; wsl</code></pre><p>更多的配置信息可以参考：<a href=https://learn.microsoft.com/zh-cn/windows/wsl/wsl-config target=_blank rel=noopener>https://learn.microsoft.com/zh-cn/windows/wsl/wsl-config</a></p><h2 id=启用-systemd>启用 systemd</h2><p>在 WSL 配置文件中添加如下内容：</p><pre><span class=code-lang>ini</span><code class=language-ini>[boot]
systemd = true</code></pre><h2 id=禁止-wsl-和-windows-交互>禁止 WSL 和 Windows 交互</h2><p>默认情况下，WSL 中可以执行 Windows 程序。其底层利用 binfmt_misc 实现：当 Linux 执行 PE 文件时，匹配到 <code>magic 4d5a</code> ，会交给 <em>/init</em> 运行。事实上，WSL 中执行的 Windows 程序，最终是都在 Windows 系统中执行的。而 <em>/init</em> 会和宿主 Windows 系统进行交互，传递执行参数并将执行结果返回到 WSL 中。</p><p>此外，WSL 还会将 Windows 环境变量 PATH 中的路径添加到 Linux 的 path 环境变量中。如果 Linux 系统和 Windows 系统中有相同文件名的可执行文件，这一特性某些情况下会导致冲突，在前文《<a href=./running-lazarus-ide-in-wsl/>在 WSL 中运行 Lazarus IDE</a>》中描述了这个问题。</p><p>在 WSL 配置文件中添加如下内容：</p><pre><span class=code-lang>ini</span><code class=language-ini>[interop]
enable = false # 关闭执行 Windows 程序的功能
appendWindowsPath = false # 不允许添加 Windows 的可执行路径到 path 中</code></pre><p>通过下面的命令可以在当前会话中临时关闭执行 Windows 程序的功能：</p><pre><span class=code-lang>bash</span><code class=language-bash>echo 0 &gt; /proc/sys/fs/binfmt_misc/WSLInterop</code></pre><p>通过下面的命令开启：</p><pre><span class=code-lang>bash</span><code class=language-bash>echo 1 &gt; /proc/sys/fs/binfmt_misc/WSLInterop</code></pre><h2 id=共享环境变量>共享环境变量</h2><p>WSL 和 Windows 共享一个名为 <code>WSLENV</code> 的特殊环境变量，其值保存着需要在 WSL 和 Windows 之间共享的环境变量列表。列表的规则如下：</p><ul><li>环境变量列表由冒号分隔</li><li>每个变量可以跟随一个斜杠分隔的标志，含义如下：<ul><li><code>/p</code> - 在 WSL/Linux 样式路径与 Win32 路径之间转换路径。</li><li><code>/l</code> - 指示环境变量是路径列表。</li><li><code>/u</code> - 指示仅当从 Win32 运行 WSL 时，才应包含此环境变量。</li><li><code>/w</code> - 指示仅当从 WSL 运行 Win32 时，才应包含此环境变量。</li></ul></li><li>如果环境变量值是路径列表，在 WSL 中，列表应由冒号分隔；在 Windows 中，列表应由分号分隔</li><li>可以在 <em>~/.bashrc</em> 中或者 Windows 环境中设置 WSLENV</li></ul><p>比如，我们需要在 WSL 中使用 Windows 的环境变量 <code>JAVA_HOME</code>，可以在 Windows 中如下操作：</p><pre><span class=code-lang>powershell</span><code class=language-powershell>$ENV:WSLENV &#43;= &#39;:JAVA_HOME/p&#39;</code></pre><p>假设 Windows 下的 <code>JAVA_HOME</code> 值为 <code>C:\jre</code>，则 WSL 中 <code>JAVA_HOME</code> 值会自动转换为 <code>/mnt/c/jre</code>。</p><h2 id=网络设置>网络设置</h2><p>WSL 1 使用和 Windows 共用相同的网络接口，WSL 和 Windows 应用之间可视作本机访问。而 WSL 2 底层为托管虚拟机，因此存在跨主机网络访问的问题。默认情况下，WSL 2 使用 NAT 模式的网络结构。对 Windows 11 版本 22H2 以上的系统，可以开启网络镜像模式。此模式下，会将 Windows 下的网络接口「镜像」到 WSL 的 Linux 环境中。</p><h3 id=启用镜像网络模式>启用「镜像」网络模式</h3><p>在 WSL 全局配置文件 <em>.wslconfig</em> 中添加以下内容：</p><pre><span class=code-lang>ini</span><code class=language-ini>[wsl2]
networkingMode = mirrored
dnsTunneling = true
firewall = true</code></pre><h3 id=nat-模式下的-wsl-和-windows-网络>NAT 模式下的 WSL 和 Windows 网络</h3><p>在 NAT 模式下，Linux 系统默认使用动态 IP。不过当 Linux 进程绑定端口时，WSL 会将端口映射到 Windows 中。底层是通过 <em>wslrelay.exe</em> 进程实现了端口转发。因此，Windows 下可以通过本机端口来访问 WSL 下的网络端口。通常情况下，我们而不需要获取 Linux 主机的 IP 地址。WSL 下可以通过下面的命令来获取 Linux 主机的 IP 地址：</p><pre><span class=code-lang>bash</span><code class=language-bash>hostname -I</code></pre><p>Windows 下则是：</p><pre><span class=code-lang>powershell</span><code class=language-powershell>wsl hostname -I</code></pre><p>而在 WSL 下要访问 Windows 主机则需要通过 IP 地址。在 Windows 中，可以查看网络适配器 &ldquo;vEthernet (WSL)&rdquo; 的 IPv4 地址来获得 Windows 主机的 IP。在 Linux 环境中，也可以通过下面的命令来获取 Windows 主机的 IP：</p><pre><span class=code-lang>bash</span><code class=language-bash>ip route show | grep -i default | awk &#39;{ print $3}&#39;</code></pre><p>需要注意的是，在没有开启镜像模式的 WSL 2 环境中，使用 localhost 地址是无法访问到 Windows 网络服务的。 另外，必须正确设置 Windows 防火墙，才能让 WSL 2 下的 Linux 进程能够访问到 Windows 主机的端口。参见：<a href=https://github.com/microsoft/WSL/issues/4585 target=_blank rel=noopener>Add &ldquo;allow&rdquo; rule to Windows firewall for WSL2 network · Issue #4585</a>。</p><h3 id=为-wsl-设置代理>为 WSL 设置代理</h3><p>对于 Windows 11 操作系统，可以在 WSL 全局配置文件 <em>.wslconfig</em> 中添加以下内容，让 WSL 使用 Windows 的系统代理服务器设置：</p><pre><span class=code-lang>ini</span><code class=language-ini>[wsl2]
autoProxy = true</code></pre><p>如果系统代理服务器使用的是本机地址，则需要开启网络镜像模式。</p><p>如果是 Windows 10 操作系统，则需要手动设置代理服务器。假设使用的代理服务器运行在 Windows 宿主的 7890 端口上，新建配置脚本 <em>/etc/profile.d/proxy.sh</em>，内容如下：</p><pre><span class=code-lang>sh</span><code class=language-sh>export https_proxy=`ip route show | grep -i default | awk &#39;{ printf &#34;http://%s:7890&#34;, $3}&#39;`
export http_proxy=`ip route show | grep -i default | awk &#39;{ printf &#34;http://%s:7890&#34;, $3}&#39;`</code></pre><p>另外，需要在 Windows 中新增一条防火墙规则，允许来自 WSL 的网络访问本地代理服务器端口。以管理员权限在 Windows 下运行以下命令：</p><pre><span class=code-lang>powershell</span><code class=language-powershell>New-NetFirewallRule -DisplayName &#34;Local Proxy&#34; -Direction Inbound -Protocol TCP -LocalPort 7890  -Action Allow</code></pre><div class=note><div class=note-content><p>使用 <code>sudo</code> 执行命令时，比如 <code>sudo apt update</code>，当前环境变量无法生效，可以通过参数显式指定代理服务器：</p><pre><span class=code-lang>shell</span><code class=language-shell>sudo apt update -o Acquire::http::Proxy=$http_proxy -o Acquire::https::Proxy=$https_proxy</code></pre><p>或者修改配置文件 <code>/etc/sudoers</code> 添加一下内容：</p><pre><code class=language-text>Defaults env_keep=&#34;http_proxy https_proxy&#34;</code></pre></div></div><h2 id=迁移-wsl-发行版镜像文件>迁移 WSL 发行版镜像文件</h2><p>WSL 发行版默认安装路径是 <em>%UserProfile%\AppData\Local\Packages\&lt;发行版名称></em> 下，发行版镜像文件则保存在安装路径下的 <em>LocalState\ext4.vhdx</em> 文件中。可以使用下面的命令将镜像文件迁移到其他路径（此处以 <em>D:\WSL\Ubuntu.vhdx</em> 为例）：</p><pre><span class=code-lang>powershell</span><code class=language-powershell>wsl --shutdown
wsl --export Ubuntu D:\WSL\Ubuntu.vhdx --vhd
wsl --unregister Ubuntu
wsl --import-in-place Ubuntu D:\WSL\Ubuntu.vhdx</code></pre><p>重新导入后，WSL 会以 root 用户身份登录，可以重新设置默认登录用户：</p><pre><span class=code-lang>powershell</span><code class=language-powershell>ubuntu config --default-user &lt;YourUserName&gt;</code></pre><h2 id=vscode-远程开发扩展包>VSCode 远程开发扩展包</h2><p>安装 <a href="https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.vscode-remote-extensionpack" target=_blank rel=noopener>Remote Development</a> 扩展包，让 VSCode 支持使用 WSL 开发环境。有两种方法可以启动远程开发：</p><ol><li>在 WSL 命令行下，运行命令：<pre><span class=code-lang>bash</span><code class=language-bash>code ~\myproject</code></pre></li><li>在 VSCode 中用 Ctrl+Shift+P 打开命令面板，输入 <code>WSL</code>，点击 <code>WSL: Connect to WSL</code></li></ol><p>方法一需要开启 WSL 和 Windows 交互功能。</p><h2 id=配置中文环境>配置中文环境</h2><p>编辑文件 <em>/etc/locale.gen</em>，移除 <code># zh_CN.UTF-8 UTF-8</code> 行首的注释；编辑文件 <em>/etc/default/locale</em>，添加一行内容：</p><pre><span class=code-lang>ini</span><code class=language-ini>LANG=zh_CN.UTF-8</code></pre><p>运行下面命令生成本地信息：</p><pre><span class=code-lang>bash</span><code class=language-bash>sudo locale-gen</code></pre><p>也可以运行 <code>sudo dpkg-reconfigure locales</code> 进行配置。</p><h2 id=运行-linux-gui-程序>运行 Linux GUI 程序</h2><p>WSL 2 自带 <a href=https://devblogs.microsoft.com/commandline/wslg-architecture/ target=_blank rel=noopener>WSLg</a> 组件可以让 WSL 中的 GUI 应用直接在 Windows 中进行渲染。WSLg 提供了 Wayland, X Server 和 PulseAudio 服务，底层通过微软的 RDP 协议和 Windows 连接，具体由 <em>msrdc.exe</em> 进程实现。</p><p>也可以使用其他第三方 X Server 服务。推荐 MobaXterm 自带的 X Server，当使用 MobaXterm 启动 WSL 环境时，会自动配置好环境变量 <code>DISPLAY</code> 的值，而无需手动设置。</p><p>如果无法运行 Linux 下的 GUI 程序，请确认当前环境是否存在如下环境变量：</p><pre><code class=language-text>WSL2_GUI_APPS_ENABLED=1
WAYLAND_DISPLAY=wayland-0
DISPLAY=:0</code></pre><p>可以在 WSL 全局配置文件 <em>.wslconfig</em> 中关闭这一特性：</p><pre><span class=code-lang>ini</span><code class=language-ini>[wsl2]
guiApplications = false</code></pre><p>如果是 WSL 1 则必须要第三方的 X Server 支持。</p><h3 id=安装中文字体>安装中文字体</h3><p>WSL 的 Ubuntu 默认没有安装中文。为了让 GUI 应用显示中文，至少需要安装一款中文字体：</p><pre><span class=code-lang>bash</span><code class=language-bash>sudo apt install fonts-noto-cjk</code></pre><p>也可以共享 Windows 字体：</p><pre><span class=code-lang>bash</span><code class=language-bash>sudo apt install fontconfig</code></pre><p>新建配置文件 <em>/etc/fonts/local.conf</em> 并保存如下内容：</p><pre><span class=code-lang>xml</span><code class=language-xml>&lt;fontconfig&gt;
  &lt;dir&gt;/mnt/c/Windows/Fonts/&lt;/dir&gt;
&lt;/fontconfig&gt;</code></pre><p>不过考虑到 WSL 下访问 Windows 文件系统性能较差，也许共享 Windows 字体并不是一个好主意。</p><h3 id=安装中文输入法>安装中文输入法</h3><p>不知什么原因，尝试了安装 IBus 输入法也启动了 <code>ibus-daemon</code>，但输入法仍无法使用。推荐安装 fcitx 输入法：</p><pre><span class=code-lang>bash</span><code class=language-bash>sudo apt-get install fcitx-pinyin</code></pre><p>新建配置脚本 <em>/etc/profile.d/fcitx-ime.sh</em>，内容如下：</p><pre><span class=code-lang>sh</span><code class=language-sh>export XMODIFIERS=@im=fcitx 
export GTK_IM_MODULE=fcitx 
export QT_IM_MODULE=fcitx
export DefaultIMModule=fcitx</code></pre><p>可以运行命令 <code>fcitx-configtool</code> 进行输入法配置。最后启动 <em>fcitx</em> 进程：</p><pre><span class=code-lang>bash</span><code class=language-bash>fcitx &amp;&gt;/dev/null</code></pre><div class=note><div class=note-content><p><a href=https://snapcraft.io/ target=_blank rel=noopener>snap</a> 安装的应用无法使用 fcitx 输入法，这个<a href=https://forum.snapcraft.io/t/fcitx-does-not-works-on-some-snap-apps/15995 target=_blank rel=noopener>问题</a>似乎至今还未解决。这里推荐使用 flathub 安装应用。</p></div></div><h3 id=kde-应用图标丢失>KDE 应用图标丢失</h3><p>使用 apt 安装的 KDE 应用（诸如 dolphin, konsole, kate 等）不显示图标。解决方法如下：</p><ol><li><p>安装 qt5ct</p><pre><span class=code-lang>bash</span><code class=language-bash>sudo apt install qt5ct</code></pre></li><li><p>设置环境变量</p><pre><span class=code-lang>bash</span><code class=language-bash>export QT_QPA_PLATFORMTHEME=qt5ct</code></pre></li></ol><div class=note><div class=note-content><p>环境变量可以在配置文件 <em>~/.bashrc</em> 或 <em>~/.profile</em> 中持久化设置</p></div></div><h3 id=修复-qtqpaxcb-could-not-connect-to-display>修复 &ldquo;qt.qpa.xcb: could not connect to display&rdquo;</h3><p>引起这个错误的原因有很多。首先可以尝试安装以下包来修复这个问题：</p><pre><span class=code-lang>bash</span><code class=language-bash>sudo apt install libxcb-xinerama0 libqt5x11extras5</code></pre><p>不过通常情况下，Ubuntu 已经默认安装了这两个包。因此上面的方案解决问题的概率很小。</p><p>下面是 WSLg 运行来自 flathub 的 <a href=https://flathub.org/apps/org.kde.dolphin target=_blank rel=noopener>Dolphin</a> 时所提示的错误：</p><pre><code class=language-text>qt.qpa.xcb: could not connect to display
qt.qpa.plugin: Could not load the Qt platform plugin &#34;xcb&#34; in &#34;&#34; even though it was found.
This application failed to start because no Qt platform plugin could be initialized. Reinstalling the application may fix this problem.

Available platform plugins are: eglfs, minimal, minimalegl, offscreen, vnc, wayland-egl, wayland, wayland-xcomposite-egl, wayland-xcomposite-glx, xcb.</code></pre><p>由于 WSLg 使用的是 wayland 协议，可以通过设置如下的环境变量来解决问题：</p><pre><span class=code-lang>bash</span><code class=language-bash>export QT_QPA_PLATFORM=wayland</code></pre><p>或者通过运行参数来指定环境变量：</p><pre><span class=code-lang>bash</span><code class=language-bash>flatpak run --env=QT_QPA_PLATFORM=wayland org.kde.dolphin</code></pre><p>奇怪的是，其他来自 flathub 的 KDE 应用（也是基于 Qt）都运行正常。这可能和应用默认打包的参数有关吧。</p><blockquote><p>The plugins can be described as follows:</p><ul><li>Linux plugins - those use Linux-specific input devices and various output devices<ul><li>wayland (since Qt 5.11) - Allows to run Qt applications on Wayland display servers.</li><li>eglfs - Uses the OpenGL ES in fullscreen mode. There&rsquo;s no other way since OpenGL has no concept of a window manager.</li><li>directfb (not directfp) - Uses the linux frame buffer with OpenGL ES via the <a href=https://web.archive.org/web/20150801232231/http://www.directfb.org/ target=_blank rel=noopener>directfb</a> layer (see also <a href=https://en.wikipedia.org/wiki/DirectFB target=_blank rel=noopener>wikipedia</a>). Integrates into the directfb windowing.</li><li>linuxfb - Uses the linux frame buffer in fullscreen mode. There&rsquo;s no other way since linuxfb has no concept of a window manager.</li><li>kms - Uses linux kernel modesetting API in fullscreen mode. There&rsquo;s no other way since DRM has no concept of a window manager.</li><li>openwfd - Uses an <a href=http://www.freedesktop.org/wiki/Software/openwfd/ target=_blank rel=noopener>openwfd</a> Wifi display in fullscreen mode. There&rsquo;s no other way since openwfd has no concept of a window manager.</li></ul></li><li>Platform-independent plugins - could be made to run on any OS<ul><li>xcb - Runs on an X11 server and is integrated into the X11 windowing environment. Generally it won&rsquo;t behave correctly without a window manager running as well. Can be made to work on Windows, given a Windows implementation of xlib, if you want to, say, serve applications from a Windows server to X11 thin terminals (typically Unix boxes).</li><li>offscreen - Renders to an offscreen buffer. Useful for rendering to custom displays.</li><li>minimal - A minimalistic backing store that optionally dumps the virtual screen to a file. Implements the bare minimum of functionality just to demonstrate how to start writing a platform plugin.</li></ul></li><li>Other platform-specific plugins<ul><li>android - Uses the Android APIs and is integrated into the Android environment.</li><li>windows - Uses the WINAPI and is integrated into the Windows windowing environment.</li><li>cocoa - Uses the Cocoa APIs and is integrated into the OS X windowing environment.</li><li>iOS - Uses the iOS toolkits and is integrated into the iOS environment.</li><li>qnx - Uses the QNX APIs and is integrated into the QNX photon windowing environment.</li></ul></li></ul></blockquote><h2 id=升级-ubuntu>升级 Ubuntu</h2><p>WSL 默认安装的是 Ubuntu 系统。微软应用商店目前提供了 18、20、22、24 几个版本。若要升级当前已安装的 Ubuntu 版本，可以在 Ubuntu 命令行中执行：</p><pre><span class=code-lang>bash</span><code class=language-bash>sudo do-release-upgrade</code></pre><p>正常情况下，执行该命令后系统就会开始升级。但有时会遇到如下错误：</p><pre><code class=language-text>Please install all available updates for your release before upgrading.</code></pre><p>这通常是由于某个安装包损坏导致的。运行命令 <code>sudo apt upgrade</code> 找到损坏的包：</p><pre><code class=language-text>下列软件包的版本将保持不变：
  xdg-desktop-portal xdg-desktop-portal-gtk
升级了 0 个软件包，新安装了 0 个软件包，要卸载 0 个软件包，有 2 个软件包未被升级。</code></pre><p>运行 <code>sudo apt upgrade xdg-desktop-portal</code> 命令升级，提示 fuse3 包已损坏。这时候删除并重新安装 xdg-desktop-portal 包即可：</p><pre><span class=code-lang>bash</span><code class=language-bash>sudo apt remove xdg-desktop-portal
sudo apt install xdg-desktop-portal</code></pre><p>安装完毕后再次运行 <code>sudo do-release-upgrade</code> 命令，可以正常升级了。</p></div><div class=taxonomy data-pagefind-ignore><div class=taxonomy-tags><ul class=tags><li>#<a data-pagefind-filter=标签 href=/tags/WSL/>WSL</a></li></ul></div></div><div class=pagination data-pagefind-ignore><a href=/posts/rye-python-environment-and-package-management-tool/ class="left arrow">上一篇：<br>Rye！就决定是你了！</a>
<a href=/moments/202403/1709869113/ class="right arrow">下一篇</a>
<a href=# class=top>返回顶部</a></div></main><script src=/js/page.js></script><script src=/js/main.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/highlight.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/scala.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/nim.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/powershell.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/nginx.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/delphi.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/dos.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/haxe.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://unpkg.com/highlightjs-svelte/dist/svelte.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=/js/code.js></script><script>hljs.highlightAll(),hljs.initLineNumbersOnLoad(),hljs.initSelectLines()</script><footer><span>&copy; <time datetime="2024-11-27 08:18:02.589853855 +0000 UTC m=+0.895575121">2024</time> fournoas.com. Powered by <a href=https://gohugo.io>Hugo</a>.</span></footer></body></html>