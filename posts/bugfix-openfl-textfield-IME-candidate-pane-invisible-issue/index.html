<!doctype html><html lang=zh-CN><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="在前文《试用跨平台 GUI 框架 HaxeUI》中提到了 OpenFL 的 TextField 在启用输入法时无法显示候选词列表的问题。经过一番摸索，发现了问题出在了 SDL 库的身上。
OpenFL 的底层基于 Lime ，而 Lime 的桌面后端又是基于 SDL 。OpenFL 默认使用的 SDL 代码位于 openfl/libsdl 。问题定位于源文件 SDL_windowskeyboard.c 中的 IME_init() 函数中，只要将第 373 行的代码注释掉，就可以正常显示输入法候选词列表了："><title>修复 OpenFL 的 TextField 不显示输入法候选词列表的问题 &#183; 白汤四物</title>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/fontawesome.min.css crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/solid.min.css crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/regular.min.css crossorigin=anonymous referrerpolicy=no-referrer><script src=https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js crossorigin=anonymous></script><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/styles/rainbow.min.css crossorigin=anonymous referrerpolicy=no-referrer><link href rel=alternate type=application/rss+xml title=白汤四物><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-3GNL63B62Q"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3GNL63B62Q")</script></head><body><nav class=nav><div class=nav-container><h1 class=nav-title><a href=/><img src=/logo.png alt=白汤四物></a></h1><ul><li><a href=/posts/><span>文章</span></a></li><li><a href=/moments/><span>动态</span></a></li><li><a href=/categories/><span>分类</span></a></li><li><a href=/tags/><span>标签</span></a></li><li><a href=/search/><span>搜索</span></a></li><li><a href=/about/><span>关于</span></a></li></ul></div></nav><main data-pagefind-body><div class="page post"><h1 class=post-title data-pagefind-meta=title>修复 OpenFL 的 TextField 不显示输入法候选词列表的问题</h1><div class=post-line></div><div class=post-info><span>作者</span>
<span data-pagefind-meta=作者>Fournoas
</span><span>写于&nbsp;</span><time datetime="2024-02-27 00:00:00 +0000 UTC" data-pagefind-meta=日期>2024年2月27日</time>
<span>发布在&nbsp;</span><ul class=categories><li><a data-pagefind-filter=分类 href=/categories/coding/>Coding</a></li></ul></div><p>在前文《<a href=../cross-platform-GUI-framework-HaxeUI-trials/>试用跨平台 GUI 框架 HaxeUI</a>》中提到了 <a href=https://www.openfl.org/ target=_blank rel=noopener>OpenFL</a> 的 <a href=https://api.openfl.org/openfl/text/TextField.html target=_blank rel=noopener>TextField</a> 在启用输入法时无法显示候选词列表的问题。经过一番摸索，发现了问题出在了 <a href=https://www.libsdl.org/ target=_blank rel=noopener>SDL</a> 库的身上。</p><p>OpenFL 的底层基于 <a href=https://lime.openfl.org/ target=_blank rel=noopener>Lime</a> ，而 Lime 的桌面后端又是基于 SDL 。OpenFL 默认使用的 SDL 代码位于 <a href=https://github.com/openfl/libsdl target=_blank rel=noopener>openfl/libsdl</a> 。问题定位于源文件 <a href=https://github.com/openfl/libsdl/blob/master/src/video/windows/SDL_windowskeyboard.c target=_blank rel=noopener>SDL_windowskeyboard.c</a> 中的 <code>IME_init()</code> 函数中，只要将第 373 行的代码注释掉，就可以正常显示输入法候选词列表了：</p><figure class=code><pre><span class=code-lang>c&#43;&#43;</span><code data-ln-selected=373 data-ln-start-from=339 data-ln=true class=language-c++>static void
IME_Init(SDL_VideoData *videodata, HWND hwnd)
{
    if (videodata-&gt;ime_initialized)
        return;

    videodata-&gt;ime_hwnd_main = hwnd;
    if (SUCCEEDED(WIN_CoInitialize())) {
        videodata-&gt;ime_com_initialized = SDL_TRUE;
        CoCreateInstance(&amp;CLSID_TF_ThreadMgr, NULL, CLSCTX_INPROC_SERVER, &amp;IID_ITfThreadMgr, (LPVOID *)&amp;videodata-&gt;ime_threadmgr);
    }
    videodata-&gt;ime_initialized = SDL_TRUE;
    videodata-&gt;ime_himm32 = SDL_LoadObject(&#34;imm32.dll&#34;);
    if (!videodata-&gt;ime_himm32) {
        videodata-&gt;ime_available = SDL_FALSE;
        SDL_ClearError();
        return;
    }
    videodata-&gt;ImmLockIMC = (LPINPUTCONTEXT2 (WINAPI *)(HIMC))SDL_LoadFunction(videodata-&gt;ime_himm32, &#34;ImmLockIMC&#34;);
    videodata-&gt;ImmUnlockIMC = (BOOL (WINAPI *)(HIMC))SDL_LoadFunction(videodata-&gt;ime_himm32, &#34;ImmUnlockIMC&#34;);
    videodata-&gt;ImmLockIMCC = (LPVOID (WINAPI *)(HIMCC))SDL_LoadFunction(videodata-&gt;ime_himm32, &#34;ImmLockIMCC&#34;);
    videodata-&gt;ImmUnlockIMCC = (BOOL (WINAPI *)(HIMCC))SDL_LoadFunction(videodata-&gt;ime_himm32, &#34;ImmUnlockIMCC&#34;);

    IME_SetWindow(videodata, hwnd);
    videodata-&gt;ime_himc = ImmGetContext(hwnd);
    ImmReleaseContext(hwnd, videodata-&gt;ime_himc);
    if (!videodata-&gt;ime_himc) {
        videodata-&gt;ime_available = SDL_FALSE;
        IME_Disable(videodata, hwnd);
        return;
    }
    videodata-&gt;ime_available = SDL_TRUE;
    IME_UpdateInputLocale(videodata);
    IME_SetupAPI(videodata);
    videodata-&gt;ime_uiless = UILess_SetupSinks(videodata);
    IME_UpdateInputLocale(videodata);
    IME_Disable(videodata, hwnd);
}</code></pre><figcaption>src/video/windows/SDL_windowskeyboard.c</figcaption></figure><p>事实上，最新版的 SDL 已经修复了这个问题<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>，但是 OpenFL 使用的 SDL 代码已经很久没更新了。SDL 官方的修复方案是此处增加了一个条件判断：</p><pre><span class=code-lang>c&#43;&#43;</span><code class=language-c++>if (WIN_ShouldShowNativeUI()) {
    videodata-&gt;ime_uiless = SDL_FALSE;
} else {
    videodata-&gt;ime_uiless = UILess_SetupSinks(videodata);
}</code></pre><p>其中 <code>WIN_ShouldShowNativeUI()</code> 的代码如下：</p><pre><span class=code-lang>c&#43;&#43;</span><code class=language-c++>static SDL_bool WIN_ShouldShowNativeUI()
{
    return SDL_GetHintBoolean(SDL_HINT_IME_SHOW_UI, SDL_FALSE);
}</code></pre><p>遗憾的是，旧版的 SDL 代码中未定义 <code>SDL_HINT_IME_SHOW_UI</code> 宏，上面的代码不可用。不过我们只需要将这行代码注释掉或者改成 <code>videodata->ime_uiless = SDL_FALSE;</code> 就可以了。</p><p>现在，需要用我们修改过并重新编译的 Lime 库来替代 haxelib 上的官方库。</p><p>首先，从 GitHub 上克隆 Lime 项目的代码：</p><pre><span class=code-lang>shell</span><code class=language-shell>git clone --recursive https://github.com/openfl/lime</code></pre><p>可以切换到 master 分支，也可以直接使用 develop 分支。</p><p>假设刚才克隆的 Lime 项目路径为 <em>D:\Projects\lime</em> ，将已安装的 Lime 库重定位到本地项目：</p><pre><span class=code-lang>shell</span><code class=language-shell>haxelib dev lime D:\Projects\lime</code></pre><p>使用 <code>haxelib list</code> 命令查看所有已安装的 Haxe 库。如果结果为：</p><pre><code class=language-text>lime: 8.1.1 [dev:D:\Projects\lime]</code></pre><p>则表示命令已经生效。</p><p>修改项目下 <em>project/lib/sdl/src/video/windows/SDL_windowskeyboard.c</em> 文件的代码，按照之前提到的方法，将 <code>videodata->ime_uiless = UILess_SetupSinks(videodata);</code> 注释掉，或者修改为 <code>videodata->ime_uiless = SDL_FALSE;</code> 。</p><p>重新编译 Lime 库：</p><pre><span class=code-lang>shell</span><code class=language-shell>lime rebuild windows</code></pre><p>如果编译成功，会在项目下 <em>ndll/Windows</em> 和 <em>ndll/Windows64</em> 下分别生成如下文件：</p><ul><li>lime.ndll</li><li>lime.ndll.hash</li><li>lime-debug.ndll</li><li>lime-debug.ndll.hash</li></ul><p>最后，重新编译 HaxeUI 项目：</p><pre><span class=code-lang>shell</span><code class=language-shell>haxelib run haxeui-core build openfl windows</code></pre><p>现在，输入法候选词列表已经可以正常显示了。</p><figure><img src=/posts/bugfix-openfl-textfield-IME-candidate-pane-invisible-issue/ime-candidate-list.png alt=ime-candidate-list></figure><hr><p>所幸，从下一个版本 (8.2.0) 开始，Lime 依赖的 SDL 代码会从 <a href=https://github.com/openfl/libsdl target=_blank rel=noopener>openfl/libsdl</a> 切换到 <a href=https://github.com/libsdl-org/SDL target=_blank rel=noopener>libsdl-org/SDL</a> ，这个问题应该会被修复。不过我克隆了 <a href=https://github.com/openfl/lime/tree/8.2.0-Dev target=_blank rel=noopener>8.2.0-Dev</a> 分支，发现 <code>SDL_HINT_IME_SHOW_UI</code> 并未默认开启，仍需要修改代码来修复。</p><p>首先克隆下 8.2.0-Dev 分支：</p><pre><span class=code-lang>shell</span><code class=language-shell>git clone --recursive -b 8.2.0-Dev https://github.com/openfl/lime D:\Projects\lime-8.2.0</code></pre><p>打开项目下的 <em>project/src/backend/sdl/SDLWindow.cpp</em> 文件，在 <code>SDLWindow::SDLWindow()</code> 函数中添加代码：</p><pre><span class=code-lang>c&#43;&#43;</span><code class=language-c++>#if defined (HX_WINDOWS)
SDL_SetHint (SDL_HINT_IME_SHOW_UI, &#34;1&#34;);
#endif</code></pre><p>切换 Lime 库路径并重新编译：</p><pre><span class=code-lang>shell</span><code class=language-shell>haxelib dev lime D:\Projects\lime-8.2.0
lime rebuild windows</code></pre><p>最后希望 8.2.0 正式发布时能够真正修复这个 BUG 。</p><hr><h1 id=修复-nme-的-textfield-不显示输入法候选词列表的问题>修复 NME 的 TextField 不显示输入法候选词列表的问题</h1><p>按照相同的方法，我们也可以修复NME 的 TextField 不显示输入法候选词列表的问题。</p><p>安装依赖包和下载 NME 项目代码：</p><pre><span class=code-lang>shell</span><code class=language-shell>haxelib install gm2d
haxelib install format
haxelib install nme-toolkit
haxelib install hxcpp
git clone --recursive https://github.com/haxenme/nme D:\Projects\nme</code></pre><p>编辑 haxe 安装目录下的 <em>lib\nme-toolkit\6,3,4\sdl\src\video\windows\SDL_windowskeyboard.c</em> 源代码文件，按照上文进行修改。</p><p>重新编译 NME：</p><pre><span class=code-lang>shell</span><code class=language-shell>cd D:\Projects\nme
haxelib dev nme .
cd D:\Projects\nme\tools\nme
haxe compile.hxml
cd D:\Projects\nme\project
haxelib run hxcpp ToolkitBuild.xml -DHXCPP_M64</code></pre><p>编译完成后会在目录 <em>D:\Projects\nme\ndll\Windows64</em> 下生成 <em>nme.ndll</em> 文件。将此文件替换项目中的同名文件即可。</p><p>不过修复后仍有两个问题：</p><ol><li>输入法候选词列表不跟随 TextField，而处在桌面底部</li><li>开启输入法输入时，一次只能输入一个字符</li></ol><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://discourse.libsdl.org/t/sdl-added-support-for-showing-the-ime-candidate-window-on-windows/32710 target=_blank rel=noopener>SDL: Added: Support for showing the IME Candidate Window on Windows</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><div class=taxonomy data-pagefind-ignore><div class=taxonomy-tags><ul class=tags><li>#<a data-pagefind-filter=标签 href=/tags/Haxe/>Haxe</a></li></ul></div></div><div class=pagination data-pagefind-ignore><a href=/moments/202403/1709538149/ class="left arrow">上一篇</a>
<a href=/posts/cross-platform-GUI-framework-HaxeUI-trials/ class="right arrow">下一篇：<br>试用跨平台 GUI 框架 HaxeUI</a>
<a href=# class=top>返回顶部</a></div></main><script src=/js/page.js></script><script src=/js/main.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/highlight.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/scala.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/nim.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/powershell.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/nginx.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/delphi.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/dos.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/haxe.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://unpkg.com/highlightjs-svelte/dist/svelte.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://unpkg.com/highlightjs-zig/dist/zig.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=/js/code.js></script><script>hljs.highlightAll(),hljs.initLineNumbersOnLoad(),hljs.initSelectLines()</script><footer><span>&copy; <time datetime="2025-04-01 09:51:26.646329689 +0000 UTC m=+1.032603850">2025</time> fournoas.com. Powered by <a href=https://gohugo.io>Hugo</a>.</span></footer></body></html>