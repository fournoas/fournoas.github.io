<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>汉化 foobar2000 的一种方案 &#183; 白汤四物</title><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/fontawesome.min.css crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/solid.min.css crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/regular.min.css crossorigin=anonymous referrerpolicy=no-referrer><script src=https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js crossorigin=anonymous></script>
<link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/styles/rainbow.min.css crossorigin=anonymous referrerpolicy=no-referrer><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/highlight.min.js crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/languages/scala.min.js crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/languages/nim.min.js crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/languages/powershell.min.js crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/languages/nginx.min.js crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=/js/code.js></script>
<script>hljs.highlightAll(),hljs.initLineNumbersOnLoad(),hljs.initSelectLines()</script><link href rel=alternate type=application/rss+xml title=白汤四物><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><script async src="https://www.googletagmanager.com/gtag/js?id=UA-153840298-1"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-153840298-1")</script></head><body><nav class=nav><div class=nav-container><h1 class=nav-title><a href=/><img src=/logo.png alt=白汤四物></a></h1><ul><li><a href=/posts/><span>文章</span></a></li><li><a href=/moments/><span>动态</span></a></li><li><a href=/categories/><span>分类</span></a></li><li><a href=/tags/><span>标签</span></a></li><li><a href=/search/><span>搜索</span></a></li><li><a href=/about/><span>关于</span></a></li></ul></div></nav><main data-pagefind-body><div class="page post"><h1 class=post-title data-pagefind-meta=title>汉化 foobar2000 的一种方案</h1><div class=post-line></div><div class=post-info><span>作者</span>
<span data-pagefind-meta=作者>Fournoas</span>
<span>于&nbsp;</span><time datetime="2022-01-29 00:00:00 +0000 UTC" data-pagefind-meta=日期>2022年1月29日</time>
<span>发布在&nbsp;</span><ul class=categories><li><a data-pagefind-filter=分类 href=/categories/using/>Using</a></li></ul></div><p><a href=https://docs.microsoft.com/zh-cn/windows/win32/debug/pe-format target=_blank rel=noopener>PE（Portable Executable）格式</a>是 Windows 下可执行文件的标准格式。PE 文件中包含菜单、对话框、字符串等资源数据。汉化的原理就是使用 Resource Hacker 或 eXeScope 等 PE 文件资源编辑软件，用中文替换掉资源中的英文。</p><p>然而，foobar2000 的菜单并没有使用资源的方式保存在 PE 文件中，也未使用字符串资源。除了部分对话框资源可以用资源编辑器行汉化之外，其余诸如菜单、按钮、列表等，均无法采用上面的方法进行汉化。这些用户界面上的字符串都是以静态数据的方式保存在 .rdata 节中。现在需要定位这些 PE 文件中的静态字符串。用十六进制编辑器打开 foobar2000.exe 文件，可以看到这些字符串。但是手工定位非常繁琐，可以采用 strings 命令来简化操作。</p><p>strings 命令属于 GNU binutils 中的一个工具，可以通过 Scoop 安装：</p><pre><code class=language-powershell>scoop install binutils
</code></pre><p>使用 strings 获取 PE 文件中的所有静态字符串：</p><pre><code class=language-powershell>strings -d -t x foobar2000.exe
</code></pre><blockquote><p>1c3418 File<br>&mldr; &mldr;<br>1c45b0 Exit<br>1c4848 Edit<br>1c4850 View<br>1c4858 Library<br>1c4860 Help</p></blockquote><p>返回的每一行代表找到的静态字符串，每行开头的十六进制数据表示字符串在文件中的偏移量。只要把这些找到的字符串替换成中文就可以完成汉化了。</p><p>不过还有个问题，就是 foobar2000 内部采用 UTF-8 编码，而一个 UTF-8 编码的汉字要占用三个字节。也就是说，原来英文字符串所占用的长度可能容纳不下翻译后的中文。这就比较麻烦了。虽然可以通过数据重新定位等方式来进行扩容，但是要反编译软件后手工修正。如果不适用自动化工具，人力成本未免太高了。现在网上流行的汉化版 <a href=https://github.com/dream7180/foobox-cn/releases target=_blank rel=noopener>foobox-cn</a> 似乎就是通过这种方式来实现汉化的。</p><p>另辟蹊径的方法是通过 Component 的方式将 dll 加载到 foobar2000 的进程中去，然后在运行时将软件 UI 上的文字进行中文替换。</p><p>通过 Spy++ 探测可知，foobar2000 的菜单是 ToolbarWindow32 窗口，也就是 Windows 通用控件里的工具条，通过 Win32 API <a href=https://docs.microsoft.com/en-us/windows/win32/api/commctrl/nf-commctrl-createtoolbarex target=_blank rel=noopener>CreateToolbarEx</a> 创建 。如果能通过 API Hook 的方式，将 CreateToolbarEx 的 lpButtons 参数替换掉，就可以实现菜单的汉化了。以此类推，将所有和渲染用户界面相关的 API 都 Hook 了，就能实现软件汉化了。</p><p>这种汉化方式的优点是不需要 Patch 原来的二进制文件，可以通过 Component 的形式独立发布。</p></div><div class=taxonomy data-pagefind-ignore><div class=taxonomy-tags><ul class=tags><li>#<a data-pagefind-filter=标签 href=/tags/foobar2000/>foobar2000</a></li></ul></div></div><div class=pagination data-pagefind-ignore><a href=/posts/configuration-of-the-music-player-foobar2000/ class="left arrow">上一篇：<br>配置音乐播放器 foobar2000</a>
<a href=/moments/202202/1644210387/ class="right arrow">下一篇</a>
<a href=# class=top>返回顶部</a></div></main><footer><span>&copy; <time datetime="2022-11-08 09:49:21.834532907 +0000 UTC m=+0.509949525">2022</time> fournoas.com. Powered by <a href=https://gohugo.io>Hugo</a> and <a href=https://pagefind.app>Pagefind</a>, theme by <a href=https://github.com/EmielH/tale-hugo>Tale</a>.</span></footer><script src=/js/page.js></script>
<script src=/js/main.js></script></body></html>