<!doctype html><html lang=zh-CN><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="在之前的一篇文章中简单介绍了如何在 Lazarus 项目中启用多语言国际化。不过使用 DefaultTranslator 或 SetDefaultLang() 无法实现运行时动态切换 GUI 的语言。更准确地说，在程序中首次调用 LCLTranslator.SetDefaultLang()，并将参数 ForceUpdate 设为 True，是能够在运行时修改 GUI 语言的，但若再次调用便无效了。
查看 SetDefaultLang() 源代码：








pascalfunction SetDefaultLang(Lang: string; Dir: string = ''; LocaleFileName: string = ''; ForceUpdate: boolean = true): string;
{ Arguments:
  Lang - language (e.g. 'ru', 'de', 'zh_CN'); empty argument is default language.
  Dir - custom translation files subdirectory (e.g. 'mylng'); empty argument means searching only in predefined subdirectories.
  LocaleFileName - custom translation file name; empty argument means that the name is the same as the one of executable.
  ForceUpdate - true means forcing immediate interface update. Only should be set to false when the procedure is
    called from unit Initialization section. User code normally should not specify it.
}
var
  lcfn: string;
  LocalTranslator: TUpdateTranslator;
  i: integer;

begin
  Result := '';
  LocalTranslator := nil;
  // search first po translation resources
  try
    lcfn := FindLocaleFileName('.po', Lang, Dir, LocaleFileName, Result);
    if lcfn <> '' then
    begin
      Translations.TranslateResourceStrings(lcfn);
      LocalTranslator := TPOTranslator.Create(lcfn);
    end
    else
    begin
      // try now with MO translation resources
      lcfn := FindLocaleFileName('.mo', Lang, Dir, LocaleFileName, Result);
      if lcfn <> '' then
      begin
        GetText.TranslateResourceStrings(UTF8ToSys(lcfn));
        LocalTranslator := TDefaultTranslator.Create(lcfn);
      end;
    end;
  except
    Result := '';
    lcfn := '';
  end;

  if lcfn<>'' then
    TranslateLCLResourceStrings(Lang, lcfn);

  if LocalTranslator<>nil then
  begin
    if Assigned(LRSTranslator) then
      LRSTranslator.Free;
    LRSTranslator := LocalTranslator;

    // Do not update the translations when this function is called from within
    // the unit initialization.
    if ForceUpdate=true then
    begin
      for i := 0 to Screen.CustomFormCount-1 do
        LocalTranslator.UpdateTranslation(Screen.CustomForms[i]);
      for i := 0 to Screen.DataModuleCount-1 do
        LocalTranslator.UpdateTranslation(Screen.DataModules[i]);
    end;
  end;
end;
lcltranslator.pas


该函数首先查找本地的 .po 或 .mo 翻译文件；然后，将程序的资源字符串翻译成本地语言；接下来，创建一个新的 TUpdateTranslator 对象替代全局对象。"><title>Lazarus 项目支持多语言国际化（进阶篇） &#183; 白汤四物</title><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/fontawesome.min.css crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/solid.min.css crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/regular.min.css crossorigin=anonymous referrerpolicy=no-referrer><script src=https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js crossorigin=anonymous></script><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/styles/rainbow.min.css crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css crossorigin=anonymous referrerpolicy=no-referrer><link href rel=alternate type=application/rss+xml title=白汤四物><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-3GNL63B62Q"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3GNL63B62Q")</script></head><body><nav class=nav><div class=nav-container><h1 class=nav-title><a href=/><img src=/logo.png alt=白汤四物></a></h1><ul><li><a href=/posts/><span>文章</span></a></li><li><a href=/moments/><span>动态</span></a></li><li><a href=/categories/><span>分类</span></a></li><li><a href=/tags/><span>标签</span></a></li><li><a href=/search/><span>搜索</span></a></li><li><a href=/about/><span>关于</span></a></li></ul></div></nav><main data-pagefind-body><div class="page post"><h1 class=post-title data-pagefind-meta=title>Lazarus 项目支持多语言国际化（进阶篇）</h1><div class=post-line></div><div class=post-info><span>作者</span>
<span data-pagefind-meta=作者>Fournoas
</span><span>写于&nbsp;</span><time datetime="2025-09-05 00:00:00 +0000 UTC" data-pagefind-meta=日期>2025年9月5日</time>
<span>发布在&nbsp;</span><ul class=categories><li><a data-pagefind-filter=分类 href=/categories/coding/>Coding</a></li></ul></div><p>在之前的一篇<a href=/posts/lazarus-project-internationalization/>文章</a>中简单介绍了如何在 Lazarus 项目中启用多语言国际化。不过使用 <code>DefaultTranslator</code> 或 <code>SetDefaultLang()</code> 无法实现运行时动态切换 GUI 的语言。更准确地说，在程序中首次调用 <code>LCLTranslator.SetDefaultLang()</code>，并将参数 <code>ForceUpdate</code> 设为 <code>True</code>，是能够在运行时修改 GUI 语言的，但若再次调用便无效了。</p><p>查看 <code>SetDefaultLang()</code> 源代码：</p><figure class=code><pre><span class=code-lang>pascal</span><code data-ln-selected=612,613,614,615,616,617,618 data-ln-start-from=562 data-ln=true class=language-pascal>function SetDefaultLang(Lang: string; Dir: string = &#39;&#39;; LocaleFileName: string = &#39;&#39;; ForceUpdate: boolean = true): string;
{ Arguments:
  Lang - language (e.g. &#39;ru&#39;, &#39;de&#39;, &#39;zh_CN&#39;); empty argument is default language.
  Dir - custom translation files subdirectory (e.g. &#39;mylng&#39;); empty argument means searching only in predefined subdirectories.
  LocaleFileName - custom translation file name; empty argument means that the name is the same as the one of executable.
  ForceUpdate - true means forcing immediate interface update. Only should be set to false when the procedure is
    called from unit Initialization section. User code normally should not specify it.
}
var
  lcfn: string;
  LocalTranslator: TUpdateTranslator;
  i: integer;

begin
  Result := &#39;&#39;;
  LocalTranslator := nil;
  // search first po translation resources
  try
    lcfn := FindLocaleFileName(&#39;.po&#39;, Lang, Dir, LocaleFileName, Result);
    if lcfn &lt;&gt; &#39;&#39; then
    begin
      Translations.TranslateResourceStrings(lcfn);
      LocalTranslator := TPOTranslator.Create(lcfn);
    end
    else
    begin
      // try now with MO translation resources
      lcfn := FindLocaleFileName(&#39;.mo&#39;, Lang, Dir, LocaleFileName, Result);
      if lcfn &lt;&gt; &#39;&#39; then
      begin
        GetText.TranslateResourceStrings(UTF8ToSys(lcfn));
        LocalTranslator := TDefaultTranslator.Create(lcfn);
      end;
    end;
  except
    Result := &#39;&#39;;
    lcfn := &#39;&#39;;
  end;

  if lcfn&lt;&gt;&#39;&#39; then
    TranslateLCLResourceStrings(Lang, lcfn);

  if LocalTranslator&lt;&gt;nil then
  begin
    if Assigned(LRSTranslator) then
      LRSTranslator.Free;
    LRSTranslator := LocalTranslator;

    // Do not update the translations when this function is called from within
    // the unit initialization.
    if ForceUpdate=true then
    begin
      for i := 0 to Screen.CustomFormCount-1 do
        LocalTranslator.UpdateTranslation(Screen.CustomForms[i]);
      for i := 0 to Screen.DataModuleCount-1 do
        LocalTranslator.UpdateTranslation(Screen.DataModules[i]);
    end;
  end;
end;</code></pre><figcaption>lcltranslator.pas</figcaption></figure><p>该函数首先查找本地的 <samp>.po</samp> 或 <samp>.mo</samp> 翻译文件；然后，将程序的资源字符串翻译成本地语言；接下来，创建一个新的 <code>TUpdateTranslator</code> 对象替代全局对象。</p><p>在调用过该函数后，新创建的 GUI 组件界面都将会使用本地语言。若要对之前已创建的组件界面进行本地化，则可以将函数参数 <code>ForceUpdate</code> 设为 <code>True</code>。这将遍历所有已创建的可视组件中所有类型为可视文本的属性，并逐一调用 <code>TUpdateTranslator.TranslateStringProperty()</code> 进行翻译。最终，会调用 <code>TMOFile.Translate()</code> 或 <code>TPOFile.Translate()</code> 将原生语言（比如英文）翻译成本地语言（比如中文）。</p><table><caption>PO文件翻译映射表</caption><thead><tr><th>msgid</th><th>msgstr</th></tr></thead><tbody><tr><td>&ldquo;File&rdquo;</td><td>&ldquo;文件&rdquo;</td></tr><tr><td>&ldquo;Edit&rdquo;</td><td>&ldquo;编辑&rdquo;</td></tr><tr><td>&ldquo;Help&rdquo;</td><td>&ldquo;帮助&rdquo;</td></tr><tr><td>&ldquo;About&rdquo;</td><td>&ldquo;关于&rdquo;</td></tr><tr><td>&mldr;</td><td>&mldr;</td></tr></tbody></table><p>当第一次调用 <code>SetDefaultLang()</code> 时，可视组件是原生语言，可以正确翻译成本地语言；而第二次调用 <code>SetDefaultLang()</code> 时，可视组件界面已经被翻译成某个本地语言，<code>TMOFile.Translate()</code> 或 <code>TPOFile.Translate()</code> 无法再将其翻译成另一种本地语言。</p><div class=mermaid>---
title: "第一次本地化翻译成功"
---
flowchart LR
Native["#quot;File#quot;"]-->|" Translate() "|Local["#quot;文件#quot;"]</div><div class=mermaid>---
title: "第二次本地化翻译失败（不存在值为\"文件\"的 msgid）"
---
flowchart LR
Local["#quot;文件#quot;"]-->|" Translate() "|AnotherLocal["？"]</div><p>通常的解决方案是，销毁已经创建的窗体，然后重新创建。窗体在创建时会加载经过二次本地化的资源字符串。不过这种方案的缺点也很明显，主窗体重建相当于程序重新启动，开发者需要自行保存和还原窗体的状态。对于程序的用户来说，体验也相当不好。</p><p>另一种解决方案是，先将已经本地化的 GUI 组件还原成原生语言，也就是初始状态，然后再次进行本地化翻译。</p><div class=mermaid>---
title: "先还原到原生语言，再翻译到另一种本地语言"
---
flowchart LR
Local["#quot;文件#quot;"]-->|还原|Native["#quot;File#quot;"]-->|" Translate() "|AnotherLocal["#quot;檔案#quot;"]</div><p>遗憾的是，<code>LCLTranslator</code> 并没有提供翻译还原的功能，这需要开发者自己实现。其原理就是，在本地化翻译的同时，记录一个 <samp>msgstr</samp> 到 <samp>msgid</samp> 逆映射表，再根据这个映射表进行文本还原。</p><p>需要注意的是，不同的原生语言，可能被翻译成同一个本地语言条目。这样在还原时就需要对文本条目的来源加以区分，而不能简单地根据翻译条目的文本映射关系进行还原。比如：英文 <samp>Property</samp> 和 <samp>Attribute</samp> 都会被翻译成「属性」。如果只用简单的文本映射，就无法确定「属性」是该还原成 <samp>Property</samp> 还是 <samp>Attribute</samp> 了。</p><table><caption>逆映射表键名加组件来源前缀</caption><thead><tr><th>msgstr</th><th>msgid</th></tr></thead><tbody><tr><td>&ldquo;Form1.Label1.Caption#属性&rdquo;</td><td>&ldquo;Property&rdquo;</td></tr><tr><td>&ldquo;Form2.Edit1.Hint#属性&rdquo;</td><td>&ldquo;Attribute&rdquo;</td></tr><tr><td>&mldr;</td><td>&mldr;</td></tr></tbody></table><p>这里实现了一个 <code>TRestorableTranslator</code> 类来替代默认的 <code>TDefaultTranslator</code>，具体实现代码如下：</p><pre><span class=code-lang>pascal</span><code class=language-pascal>unit MyTranslator;

{$mode ObjFPC}{$H&#43;}

interface

uses
  Classes, SysUtils, Generics.Collections, LCLTranslator, TypInfo;
  
type

  { TRestorableTranslator }

  TRestorableTranslator = class(TDefaultTranslator)
  type

    { TRestoreTranslator }

    TRestoreTranslator = class(TUpdateTranslator)
    private
      FTranslatedTerms: specialize TDictionary&lt;string, string&gt;;
    public
      constructor Create;
      destructor Destroy; override;
      property TranslatedTerms: specialize TDictionary&lt;string, string&gt; read FTranslatedTerms;
      procedure TranslateStringProperty(Sender: TObject; const Instance: TPersistent;
        PropInfo: PPropInfo; var Content: string); override;
    end;
  private
    FRestoreTranslator: TRestoreTranslator;
  public
    constructor Create(MOFileName: string);
    destructor Destroy; override;
    procedure TranslateStringProperty(Sender: TObject; const Instance: TPersistent;
      PropInfo: PPropInfo; var Content: string); override;
    procedure Restore;
  end; 
  
implementation

function GetPersistentPath(APersistent: TPersistent): string;
var
  TempPersistent: TPersistent;
  NamePath: string;
begin
  Result := &#39;&#39;;
  TempPersistent := APersistent;
  while Assigned(TempPersistent) do
  begin
    NamePath := TempPersistent.GetNamePath;
    if NamePath &lt;&gt; &#39;&#39; then Result := NamePath &#43; &#39;.&#39; &#43; Result;
    {$IFDEF DEBUG}{$objectChecks-}{$ENDIF}
    TempPersistent := TPersistentAccess(TempPersistent).GetOwner;
    {$IFDEF DEBUG}{$objectChecks&#43;}{$ENDIF}
  end;
end;

{ TRestorableTranslator }

constructor TRestorableTranslator.Create(MOFileName: string);
begin
  inherited Create(MOFileName);
  FRestoreTranslator := TRestoreTranslator.Create;
end;

destructor TRestorableTranslator.Destroy;
begin
  FreeAndNil(FRestoreTranslator);
  inherited Destroy;
end;

procedure TRestorableTranslator.TranslateStringProperty(Sender: TObject; const Instance: TPersistent;
  PropInfo: PPropInfo; var Content: string);
var
  OriginalContent, NamePath: string;
begin
  OriginalContent := Content;
  inherited;
  if Content &lt;&gt; OriginalContent then
  begin
    NamePath := GetPersistentPath(Instance) &#43; PropInfo^.Name;
    FRestoreTranslator.TranslatedTerms.TryAdd(NamePath &#43; #4 &#43; Content, OriginalContent);
  end;
end;

procedure TRestorableTranslator.Restore;
var
  i: integer;
  LocalTranslator: TAbstractTranslator;
begin
  LocalTranslator := LRSTranslator;
  LRSTranslator := FRestoreTranslator;
  for i := 0 to Screen.CustomFormCount-1 do
    FRestoreTranslator.UpdateTranslation(Screen.CustomForms[i]);
  for i := 0 to Screen.DataModuleCount-1 do
    FRestoreTranslator.UpdateTranslation(Screen.DataModules[i]);
  LRSTranslator := LocalTranslator;
end;

{ TRestorableTranslator.TRestoreTranslator }

constructor TRestorableTranslator.TRestoreTranslator.Create;
begin
  FTranslatedTerms := specialize TDictionary&lt;string, string&gt;.Create;
end;

destructor TRestorableTranslator.TRestoreTranslator.Destroy;
begin
  FreeAndNil(FTranslatedTerms);
  inherited Destroy;
end;

procedure TRestorableTranslator.TRestoreTranslator.TranslateStringProperty(Sender: TObject; const Instance: TPersistent;
  PropInfo: PPropInfo; var Content: string);
var
  Value, NamePath: string;
begin
  NamePath := GetPersistentPath(Instance) &#43; PropInfo^.Name;
  if FTranslatedTerms.TryGetValue(NamePath &#43; #4 &#43; Content, Value) then
    Content := Value;
end;            

end.</code></pre><p>只要在二次本地化翻译前，调用 <code>TRestorableTranslator.Restore</code> 将已翻译的组件还原成最初的状态即可。</p></div><div class=taxonomy data-pagefind-ignore><div class=taxonomy-tags><ul class=tags><li>#<a data-pagefind-filter=标签 href=/tags/Pascal/>Pascal</a></li><li>#<a data-pagefind-filter=标签 href=/tags/Lazarus/>Lazarus</a></li></ul></div></div><div class=pagination data-pagefind-ignore><a href=/posts/what-is-the-windows-userchoice-protection-driver-ucpd.sys/ class="left arrow">上一篇：<br>什么是 Windows UserChoice 保护驱动（UCPD.sys）</a>
<a href=/posts/accessing-protected-members-of-object-in-free-pascal/ class="right arrow">下一篇：<br>Free Pascal Hack 之访问对象的 protected 成员</a>
<a href=# class=top>返回顶部</a></div></main><script src=/js/page.js></script><script src=/js/main.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/highlight.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/scala.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/nim.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/powershell.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/nginx.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/delphi.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/dos.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/haxe.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://unpkg.com/highlightjs-svelte/dist/svelte.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://unpkg.com/highlightjs-zig/dist/zig.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://unpkg.com/highlightjs-redbol/dist/redbol.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=/js/code.js></script><script>hljs.highlightAll(),hljs.initLineNumbersOnLoad(),hljs.initSelectLines()</script><script src=https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.1.1/mermaid.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script>mermaid.initialize({startOnLoad:!0})</script><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js crossorigin=anonymous referrerpolicy=no-referrer onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"\\[",right:"\\]",display:!0},{left:"$$",right:"$$",display:!0},{left:"\\(",right:"\\)",display:!1}],throwOnError:!1})})</script><footer><span>&copy; <time datetime="2025-09-15 08:36:00.627767939 +0000 UTC m=+0.778281359">2025</time> fournoas.com. Powered by <a href=https://gohugo.io/>Hugo</a> v0.150.0.</span></footer></body></html>