<!doctype html><html lang=zh-CN><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="本文记录一次 WinGet 升级故障排查的过程。最终删除了 Windows 应用商店安装的版本，再使用 Scoop 重新安装，通过这种方式解决了问题。"><title>记一次 WinGet 升级故障排查 &#183; 白汤四物</title>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/fontawesome.min.css crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/solid.min.css crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/regular.min.css crossorigin=anonymous referrerpolicy=no-referrer><script src=https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js crossorigin=anonymous></script><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/styles/rainbow.min.css crossorigin=anonymous referrerpolicy=no-referrer><link href rel=alternate type=application/rss+xml title=白汤四物><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-3GNL63B62Q"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3GNL63B62Q")</script></head><body><nav class=nav><div class=nav-container><h1 class=nav-title><a href=/><img src=/logo.png alt=白汤四物></a></h1><ul><li><a href=/posts/><span>文章</span></a></li><li><a href=/moments/><span>动态</span></a></li><li><a href=/categories/><span>分类</span></a></li><li><a href=/tags/><span>标签</span></a></li><li><a href=/search/><span>搜索</span></a></li><li><a href=/about/><span>关于</span></a></li></ul></div></nav><main data-pagefind-body><div class="page post"><h1 class=post-title data-pagefind-meta=title>记一次 WinGet 升级故障排查</h1><div class=post-line></div><div class=post-info><span>作者</span>
<span data-pagefind-meta=作者>Fournoas
</span><span>写于&nbsp;</span><time datetime="2025-03-21 00:00:00 +0000 UTC" data-pagefind-meta=日期>2025年3月21日</time>
<span>发布在&nbsp;</span><ul class=categories><li><a data-pagefind-filter=分类 href=/categories/using/>Using</a></li></ul></div><p>今天像往常一样执行 <code>winget upgrade --all</code> 命令，意外地发生了错误，提示：</p><pre><code class=language-text>尝试更新源失败： winget</code></pre><p>使用 <code>--logs</code> 参数生成日志，收集到错误信息如下：</p><pre><code class=language-text>2025-03-21 10:52:17.605 [CORE] Deployment operation #0: 从  (Microsoft.Winget.Source_8wekyb3d8bbwe.msix)  使用程序包 Microsoft.Winget.Source_2025.321.215.7_neutral__8wekyb3d8bbwe 中的目标卷 C: 执行的部署 Add 操作失败，错误为 0x80070057。有关诊断应用部署问题的帮助，请参阅 http://go.microsoft.com/fwlink/?LinkId=235160。
2025-03-21 10:52:17.605 [FAIL] C:\__w\1\s\external\pkg\src\AppInstallerCommonCore\Deployment.cpp(54)\WindowsPackageManager.dll!00007FFB414154CB: (caller: 00007FFB41411209) Exception(1) tid(47b4) 80070057 参数错误。

    Msg:[Operation failed: 从  (Microsoft.Winget.Source_8wekyb3d8bbwe.msix)  使用程序包 Microsoft.Winget.Source_2025.321.215.7_neutral__8wekyb3d8bbwe 中的目标卷 C: 执行的部署 Add 操作失败，错误为 0x80070057。有关诊断应用部署问题的帮助，请参阅 http://go.microsoft.com/fwlink/?LinkId=235160。] 

2025-03-21 10:52:17.611 [FAIL] C:\__w\1\s\external\pkg\src\AppInstallerRepositoryCore\RepositorySource.cpp(96)\WindowsPackageManager.dll!00007FFB4155E285: (caller: 00007FFB41468553) LogHr(1) tid(47b4) 80070057 参数错误。

    Msg:[C:\__w\1\s\external\pkg\src\AppInstallerCommonCore\Deployment.cpp(54)\WindowsPackageManager.dll!00007FFB414154CB: (caller: 00007FFB41411209) Exception(1) tid(47b4) 80070057 参数错误。

    Msg:[Operation failed: 从  (Microsoft.Winget.Source_8wekyb3d8bbwe.msix)  使用程序包 Microsoft.Winget.Source_2025.321.215.7_neutral__8wekyb3d8bbwe 中的目标卷 C: 执行的部署 Add 操作失败，错误为 0x80070057。有关诊断应用部署问题的帮助，请参阅 http://go.microsoft.com/fwlink/?LinkId=235160。] 
] 

2025-03-21 10:52:17.611 [REPO] Source add/update failed, waiting 9311 milliseconds and retrying: winget</code></pre><p>错误代码 <samp>0x80070057</samp>。微软官方的解释如下：</p><table><thead><tr><th style=text-align:left>错误代码</th><th style=text-align:left>值</th><th style=text-align:left>描述和可能的原因</th></tr></thead><tbody><tr><td style=text-align:left><strong>E_INVALIDARG</strong></td><td style=text-align:left>0x80070057</td><td style=text-align:left>一个或多个参数无效。 如果检查 AppXDeployment-Server 事件日志并看到以下事件：“安装包时，系统由于以下错误而无法注册 windows.repositoryExtension 扩展：参数不正确。” 如果清单元素 DisplayName 或 Description 包含 Windows 防火墙不允许的字符（例如 <code>|</code>），则可能会出现此错误，因为 Windows 无法为包创建 AppContainer 配置文件。 请从清单中删除这些字符，并尝试安装包。</td></tr></tbody></table><p>根据日志中的相关信息，尝试从 <a href=https://cdn.winget.microsoft.com/cache/source2.msix target=_blank rel=noopener>https://cdn.winget.microsoft.com/cache/source2.msix</a> 下载升级安装包，手动安装提示同样的错误：</p><figure><img src=/posts/record-a-winget-upgrade-troubleshooting/failure.png alt=安装失败></figure><p>打开事件查看器（运行 <code>eventvwr.msc</code>），访问路径 <samp>应用程序和服务日志\Microsoft\Windows\AppXDeployment-Server\Microsoft-Windows-AppXDeploymentServer/Operational</samp> 下的日志，只有同样的错误信息，未找到更多线索。</p><p>试试重新安装 WinGet 看看能不能解决问题。之前的版本是通过 Windows 应用商店安装的，通过 WinGet 命令卸载此版本，并通过 Scoop 重新安装：</p><pre><span class=code-lang>powershell</span><code class=language-powershell>winget uninstall Microsoft.AppInstaller
scoop install winget</code></pre><p>再次执行 <code>winget upgrade --all</code> 命令，一切正常。不过很奇怪的是，之前卸载的 WinGet 版本是 1.25.340.0，而 Scoop 安装的 WinGet 版本是 1.10.340。</p><p>很好奇故障的原因，看了一下 WinGet 重装后的升级日志，发现虽然下载的升级文件 <samp>source2.msix</samp> 的 URL 地址没变，但是哈希值和文件大小同之前的不一样。难道这就是此前升级失败的原因？为了验证猜想，使用如下命令安装新下载的 <samp>source2 (1).msix</samp>：</p><pre><span class=code-lang>powershell</span><code class=language-powershell>add-appxpackage &#34;D:\Downloads\source2 (1).msix&#34;</code></pre><div class=note><div class=note-content><p>注意：该命令只能在 Windows 自带的 PowerShell 5 下运行，PowerShell 7 无法运行该命令。可以使用命令 <code>$psversiontable.PSVersion</code> 查看当前 PowerShell 的版本。</p><p>另外，之所以这次没有通过双击文件安装，是由于之前为了排查问题，通过 DISM++ 删除了 Windows 应用商店。不过应该不影响结果。</p></div></div><p>安装仍然失败，返回和之前相同的错误信息：</p><pre><code class=language-text>add-appxpackage : 部署失败，原因是 HRESULT: 0x80073CF9, 无法安装。请联系你的软件供应商。
从  (source2%20(1).msix)  使用程序包 Microsoft.Winget.Source_2025.321.555.13_neutral__8wekyb3d8bbwe 中的目标卷 C: 执行的部署 Add 操作失败，错误为 0x80070057。有关诊断应用部署问题的帮助，请参阅 http://go.microsoft.com/fwlink/?LinkId=235160。
注意: 有关其他信息，请在事件日志中查找 [ActivityId] c9da9f7f-9a17-0000-2dec-dac9179adb01，或使用命令行 Get-AppPackageLog -ActivityID c9da9f7f-9a17-0000-2dec-dac9179adb01
所在位置 行:1 字符: 1
&#43; add-appxpackage &#34;D:\Downloads\source2 (1).msix&#34;
&#43; ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    &#43; CategoryInfo          : WriteError: (D:\Downloads\source2 (1).msix:String) [Add-AppxPackage], IOException
    &#43; FullyQualifiedErrorId : DeploymentError,Microsoft.Windows.Appx.PackageManager.Commands.AddAppxPackageCommand</code></pre><p>看来也不是安装文件引起的。至此，虽然修复了问题，然是仍然不清楚是什么原因导致的 WinGet 故障。WinGet 在使用中已经不是第一次发生此类莫名其妙的问题，由于 WinGet 依赖了太多的系统服务，导致排查故障非常困难，真是搞得人心力交瘁。Windows 下最好的包管理器还得是 Scoop，虽然也有坑（比如最近用 Scoop 升级 GIMP 3.0.0 会由于安装脚本问题而失败，以及经常遇到的哈希校验错误），但是解决起来还是非常简单的。</p></div><div class=taxonomy data-pagefind-ignore><div class=taxonomy-tags><ul class=tags><li>#<a data-pagefind-filter=标签 href=/tags/Windows/>Windows</a></li></ul></div></div><div class=pagination data-pagefind-ignore><a href=/posts/hotfix-for-scoop-gimp-3.0-installation-script-bug/ class="left arrow">上一篇：<br>热修复 Scoop 的 GIMP 3.0 安装脚本错误</a>
<a href=/moments/202503/1742358941/ class="right arrow">下一篇</a>
<a href=# class=top>返回顶部</a></div></main><script src=/js/page.js></script><script src=/js/main.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/highlight.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/scala.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/nim.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/powershell.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/nginx.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/delphi.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/dos.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/haxe.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://unpkg.com/highlightjs-svelte/dist/svelte.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://unpkg.com/highlightjs-zig/dist/zig.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://unpkg.com/highlightjs-redbol/dist/redbol.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=/js/code.js></script><script>hljs.highlightAll(),hljs.initLineNumbersOnLoad(),hljs.initSelectLines()</script><footer><span>&copy; <time datetime="2025-05-07 08:41:21.273437647 +0000 UTC m=+1.106920656">2025</time> fournoas.com. Powered by <a href=https://gohugo.io/>Hugo</a> v0.147.2.</span></footer></body></html>