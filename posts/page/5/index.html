<!doctype html><html lang=zh-CN><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>文章 &#183; 白汤四物</title>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/fontawesome.min.css crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/solid.min.css crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/regular.min.css crossorigin=anonymous referrerpolicy=no-referrer><script src=https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js crossorigin=anonymous></script><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/styles/rainbow.min.css crossorigin=anonymous referrerpolicy=no-referrer><link href rel=alternate type=application/rss+xml title=白汤四物><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-3GNL63B62Q"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3GNL63B62Q")</script></head><body><nav class=nav><div class=nav-container><h1 class=nav-title><a href=/><img src=/logo.png alt=白汤四物></a></h1><ul><li><a href=/posts/><span>文章</span></a></li><li><a href=/moments/><span>动态</span></a></li><li><a href=/categories/><span>分类</span></a></li><li><a href=/tags/><span>标签</span></a></li><li><a href=/search/><span>搜索</span></a></li><li><a href=/about/><span>关于</span></a></li></ul></div></nav><div class=banner><main><ul class=breadcrumb><li>文章</li></ul></main></div><main class=main><div class=catalogue><div class=catalogue-item><time datetime="2022-12-05 00:00:00 +0000 UTC" class=catalogue-time>2022年12月5日</time>
<a href=https://www.fournoas.com/posts/socks5-proxy-protocol-quick-start/ class=catalogue-title>快速了解 SOCKS5 代理协议</a><div class=catalogue-line></div><p><p>SOCKS5 是最常见的代理服务协议，服务通常使用 1080 端口，支持代理 TCP/UDP 网络协议。协议由 <a href=https://datatracker.ietf.org/doc/html/rfc1928 target=_blank rel=noopener>RFC 1928</a> 定义，也可以阅读非官方翻译的<a href=https://luyuhuang.tech/2020/08/27/rfc1928.html target=_blank rel=noopener>中文版</a>。本文主要用于快速入门，省略了协议中不常用的部分。文中提供了协议的部分 Python 代码实现。</p><div class=mermaid>sequenceDiagram
title 建立 SOCKS5 代理的流程
participant client as 客户端
participant proxy as SOCKS5 代理
participant dest as 目标服务器
client->>proxy: 连接代理服务器
proxy-->>client: 连接成功
client->>proxy: 协商认证方式
proxy-->>client: 确认认证方式
opt 需要身份验证
client->>proxy: 身份验证信息
proxy-->>client: 验证通过
end
client->>proxy: 发送代理请求
proxy->>+dest: 连接目标服务器
dest-->>proxy: 连接成功
activate proxy
proxy-->>client: 请求成功
loop 开始通信
client->>proxy: 发送数据
proxy->>dest: 发送数据
dest-->>proxy: 接收数据
proxy-->>client: 接收数据
end
deactivate proxy
deactivate dest</div><p>连接 SOCKS5 代理服务的 Python 代码如下：</p>&mldr;&mldr;</p><ul class=catalogue-tags><li>#<a href=/tags/%E7%BD%91%E7%BB%9C/>网络</a></li><li>#<a href=/tags/Python/>Python</a></li></ul></div><div class=catalogue-item><time datetime="2022-11-30 00:00:00 +0000 UTC" class=catalogue-time>2022年11月30日</time>
<a href=https://www.fournoas.com/posts/asyncio.DatagramProtocol-stop-responding-when-an-error-is-received/ class=catalogue-title>asyncio.DatagramProtocol 收到错误后停止响应</a><div class=catalogue-line></div><p><p>Python 官方文档提供了一个使用 asyncio 创建 <a href=https://docs.python.org/3/library/asyncio-protocol.html#udp-echo-server target=_blank rel=noopener>UDP Echo Server</a> 的示例，代码如下：</p><pre><span class=code-lang>PYTHON</span><code class=language-python>import asyncio


class EchoServerProtocol:
    def connection_made(self, transport):
        self.transport = transport

    def datagram_received(self, data, addr):
        message = data.decode()
        print(&#39;Received %r from %s&#39; % (message, addr))
        print(&#39;Send %r to %s&#39; % (message, addr))
        self.transport.sendto(data, addr)


async def main():
    print(&#34;Starting UDP server&#34;)

    # Get a reference to the event loop as we plan to use
    # low-level APIs.
    loop = asyncio.get_running_loop()

    # One protocol instance will be created to serve all
    # client requests.
    transport, protocol = await loop.create_datagram_endpoint(
        lambda: EchoServerProtocol(),
        local_addr=(&#39;127.0.0.1&#39;, 9999))

    try:
        await asyncio.sleep(3600)  # Serve for 1 hour.
    finally:
        transport.close()


asyncio.run(main())</code></pre><p>然而，一旦收到运行时错误，该 UDP Server 便会失去响应，无法继续工作。通常来说，即使目标地址和端口未开启，发送 UDP 数据包也不会引发异常。但是在 Windows 系统上，如果向本地未开启监听的端口发送 UDP 数据包，会引起一个代码为 0x4D2 的 ERROR_PORT_UNREACHABLE 错误，其描述为「没有任何服务正在远程系统上的目标网络终结点上操作。（ No service is operating at the destination network endpoint on the remote system. ）」。在 GitHub 上已经有人提交了编号为 <a href=https://github.com/python/cpython/issues/91227 target=_blank rel=noopener>#91227</a> 的 issue ，标题是「 asyncio proactor udp transport stops responding after send to port that isn&rsquo;t listening 」。可以通过代码来复现这个问题。</p>&mldr;&mldr;</p><ul class=catalogue-tags><li>#<a href=/tags/Python/>Python</a></li></ul></div><div class=catalogue-item><time datetime="2022-11-23 00:00:00 +0000 UTC" class=catalogue-time>2022年11月23日</time>
<a href=https://www.fournoas.com/posts/the-reactionary-essence-of-the-six-black-points-for-overseas-relations/ class=catalogue-title>“海外关系黑六条”的反动实质</a><div class=catalogue-line></div><p><blockquote><p>原载于《南方日报》1978年1月24日</p></blockquote><p>如何看待华侨国内外家庭亲属间的关系，是侨务工作中一个很重要的问题。正确对待这个问题，才能正确贯彻执行党的侨务政策，团结国外国内广大华侨、侨眷、归侨，调动一切积极因素为社会主义服务。</p><p>伟大领袖和导师毛主席早在一九四五年就发出“保护华侨利益，扶助回国的华侨”的光辉指示。敬爱的周总理在第二届全国人民代表大会第三次会议上的政府工作报告中也指出：“我们还应该做好侨务工作，进一步团结海外爱国侨胞，妥善地照顾在国内的侨眷和安置归国的华侨。”新中国成立以来，党和国家根据毛主席的光辉指示和无产阶级革命路线，制订了一系列侨务政策，对团结教育广大侨眷、归侨积极参加社会主义革命和社会主义建设，巩固无产阶级专政，对扩大海外华侨爱国统一战线和国际统一战线，配合解放台湾的斗争，都起了积极的作用。二十多年来，尽管刘少奇、林彪、特别是“四人帮”对毛主席亲自制定、批准的侨务工作方针和政策进行了各种干扰、破坏，但是在侨务工作中，毛主席的革命路线始终是占主导地位的。</p>&mldr;&mldr;</p><ul class=catalogue-tags><li>#<a href=/tags/%E5%AD%A6%E5%9B%9B%E5%8F%B2%E5%AE%88%E5%88%9D%E5%BF%83/>学四史守初心</a></li></ul></div><div class=catalogue-item><time datetime="2022-11-18 00:00:00 +0000 UTC" class=catalogue-time>2022年11月18日</time>
<a href=https://www.fournoas.com/posts/principles-and-precautions-of-employee-computer-monitoring/ class=catalogue-title>公司监控员工电脑的原理和防范</a><div class=catalogue-line></div><p><p>公司监控员工的方式可以分为硬件和软件两种。前者包括办公区的监控摄像头、门禁系统、电话录音、电子围栏、打印机扫描仪使用记录等等。后者包括但不限于：</p><ol><li>手机安装 APP</li><li>员工使用公司 OA 系统的操作日志</li><li>公司网络嗅探</li><li>办公电脑安装监控软件</li><li>网络舆情监控</li></ol><p>本文主要讨论的是第 3 和第 4 种的情况。</p><blockquote><p>特别要指出一点，如果公司的办公区域比较大，且安装了多个 AP 的话，公司可以通过员工手机连接的无线热点来对员工进行定位，原理就和手机基站定位类似。这项技术还被适用于一些大型公共设施中，例如：酒店、医院、商场等。最好的防范方式就是手机不要连接陌生热点，使用自己的流量。</p>&mldr;&mldr;</p><ul class=catalogue-tags><li>#<a href=/tags/%E6%91%B8%E9%B1%BC%E5%84%BF/>摸鱼儿</a></li></ul></div><div class=catalogue-item><time datetime="2022-11-11 00:00:00 +0000 UTC" class=catalogue-time>2022年11月11日</time>
<a href=https://www.fournoas.com/posts/python-asyncio-module-implements-simple-asynchronous-https-requests/ class=catalogue-title>Python asyncio 模块实现简单异步 https 请求</a><div class=catalogue-line></div><p><p>网上关于 asyncio 实现异步 https 请求的代码几乎都是基于Python 第三方库 aiohttp 的，而我仅需要一个无第三方依赖的、能一键运行的简单 Python 脚本。翻了翻官方文档，也没有什么值得参考的 sample 代码。无奈只能自己动手撸一个。</p><p>以下示例代码的作用是，请求百度首页，并将响应打印出来。支持 Python 3.7 及以上的版本。</p><h1 id=版本一>版本一</h1><p>使用 <code>loop.create_connection()</code> 从零开始撸。</p>&mldr;&mldr;</p><ul class=catalogue-tags><li>#<a href=/tags/Python/>Python</a></li></ul></div><div class=catalogue-item><time datetime="2022-11-07 00:00:00 +0000 UTC" class=catalogue-time>2022年11月7日</time>
<a href=https://www.fournoas.com/posts/chinese-web-typesetting-design-suggestions/ class=catalogue-title>中文网页排版设计建议</a><div class=catalogue-line></div><p><h2 id=使用哪种引号>使用哪种引号</h2><p>在《<a href=http://www.moe.gov.cn/ewebeditor/uploadfile/2015/01/13/20150113091548267.pdf target=_blank rel=noopener>标点符号用法</a>》（ GB/T 15834—2011 ）中规定的双引号和单引号分别为 <code>“”</code> 和 <code>‘’</code>，这组引号起源于西文，且称作国标引号。另外，在《<a href=https://language.moe.gov.tw/001/upload/files/site_content/m0001/hau/Revised_Handbook_of_Punctuation.pdf target=_blank rel=noopener>重订标点符号手册</a>》中规定的双引号和单引号（横式）分别为 <code>『』</code> 和 <code>「」</code>，这组引号又被称为直角引号。</p><p>需要注意的是，国标引号和直角引号的单引号、双引号使用方式是相反的：国标引号，外层使用双引号，内层嵌套使用单引号；直角引号，外层使用单引号，内层嵌套使用双引号。例如：</p>&mldr;&mldr;</p><ul class=catalogue-tags><li>#<a href=/tags/%E5%89%8D%E7%AB%AF/>前端</a></li></ul></div><div class=catalogue-item><time datetime="2022-10-31 00:00:00 +0000 UTC" class=catalogue-time>2022年10月31日</time>
<a href=https://www.fournoas.com/posts/handling-signal-in-python-on-different-platforms/ class=catalogue-title>Python 信号处理在不同平台上的差异</a><div class=catalogue-line></div><p><p>在前文《<a href=/posts/why-does-ctrl-c-not-kill-python-process-in-windows-console/>为何 Windows 下无法用 Ctrl+C 终止 Python 进程</a>》中，虽然解释了产生该现象的原因，但却没有解释为何同样的代码在 Linux 下就可以用 Ctrl+C 来中止。究其原因，是由于在操作系统层面，Linux 和 Windows 对 SIGINT 的信号处理方式不同所导致的。</p><h2 id=python-的底层实现原理>Python 的底层实现原理</h2><p>Python 将操作系统或 C 标准库提供的信号处理器称作 Low-level signal handler，Python 内建的 signal 模块在其基础上进行了封装。在 <a href=https://github.com/python/cpython/blob/05e48865be69e1e5824f6915b588ff054717bb42/Python/pylifecycle.c#L3045 target=_blank rel=noopener>Python/pylifecycle.c</a> 文件中找到 <code>PyOS_setsig()</code> 函数：</p>&mldr;&mldr;</p><ul class=catalogue-tags><li>#<a href=/tags/Python/>Python</a></li></ul></div><div class=catalogue-item><time datetime="2022-10-31 00:00:00 +0000 UTC" class=catalogue-time>2022年10月31日</time>
<a href=https://www.fournoas.com/posts/python-signal-handlers-and-reentrant-call-runtime-error-of-print-function/ class=catalogue-title>Python 的 signal 处理与 print() 的 reentrant call 运行时错误</a><div class=catalogue-line></div><p><p>在前文《<a href=../why-does-ctrl-c-not-kill-python-process-in-windows-console/>为何 Windows 下无法用 Ctrl+C 终止 Python 进程</a>》中，讲解了 Python 信号处理的基本原理。当时为了撰写文章而编写了一些测试代码，在运行某例测试代码时，发生了奇怪的 reentrant call 运行时错误。代码如下：</p><pre><span class=code-lang>PYTHON</span><code class=language-python>import signal

signal.signal(signal.SIGINT, lambda signum, frame: print(&#39;test&#39;))
while True: print(&#39;test&#39;)</code></pre><p>在程序运行中按下 Ctrl+C，程序抛出 RuntimeError 异常。完整错误信息如下：</p><pre><code class=language-text>Traceback (most recent call last):
  File &#34;test.py&#34;, line 4, in &lt;module&gt;
    while True: print(&#39;test&#39;)
                ^^^^^^^^^^^^^
  File &#34;test.py&#34;, line 3, in &lt;lambda&gt;
    signal.signal(signal.SIGINT, lambda signum, frame: print(&#39;test&#39;))
                                                       ^^^^^^^^^^^^^
RuntimeError: reentrant call inside &lt;_io.BufferedWriter name=&#39;&lt;stdout&gt;&#39;&gt;</code></pre><p>错误信息中所提到的 reentrant call 是一个计算机术语，它的意思是程序或者子例程（subroutine）在执行过程中被中断，此时再次调用该程序或者子例程。由于 Python 的信号处理器是运行在主线程中，所以不存在多线程冲突的可能。因此，猜想错误可能是由如下的代码引起的：</p>&mldr;&mldr;</p><ul class=catalogue-tags><li>#<a href=/tags/Python/>Python</a></li></ul></div><div class=catalogue-item><time datetime="2022-10-28 00:00:00 +0000 UTC" class=catalogue-time>2022年10月28日</time>
<a href=https://www.fournoas.com/posts/why-does-ctrl-c-not-kill-python-process-in-windows-console/ class=catalogue-title>为何 Windows 下无法用 Ctrl+C 终止 Python 进程</a><div class=catalogue-line></div><p><p>在 Windows 命令行中按下 <code>Ctrl+C</code> 或者 <code>Ctrl+Break</code> 可以结束当前正在执行的命令。通常情况下，这个方法同样适用于 Python 的控制台进程。特别地，Python 内置了一个 <code>KeyboardInterrupt</code> 异常专门用于捕获按下 <code>Ctrl+C</code> 而触发的程序退出：</p><pre><span class=code-lang>PYTHON</span><code class=language-python>try:
    while True:
        print(&#39;running...&#39;)
except KeyboardInterrupt:
    print(&#39;keyboard interrupt received&#39;)
    # 退出前清理现场，释放资源</code></pre><p>Python 触发 <code>KeyboardInterrupt</code> 异常的底层实现原理依赖于 signal 机制<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>。使用信号处理器也可以捕获按下 <code>Ctrl+C</code> 而触发的程序退出：</p><pre><span class=code-lang>PYTHON</span><code class=language-python>import signal

def signal_handler(signum, frame):
    raise KeyboardInterrupt

signal.signal(signal.SIGINT, signal_handler)

try:
    while True:
        print(&#39;running...&#39;)
except KeyboardInterrupt:
    print(&#39;keyboard interrupt received&#39;)
    # 退出前清理现场，释放资源</code></pre><p>但是在某些情况下，Windows 的 Python 命令行程序无法用 <code>Ctrl+C</code> 或者 <code>Ctrl+Break</code> 终止。比如在 <a href=https://bugs.python.org/issue41437 target=_blank rel=noopener>issue 41437: SIGINT blocked by socket operations like recv on Windows</a> 中提到：在 Windows 中，当 <code>socket.recv()</code> 操作阻塞时，无法响应 <code>SIGINT</code>。类似的，当 <code>thread.join()</code> 操作阻塞时，也无法用 <code>Ctrl+C</code> 终止。例如下面代码在 Windows 下运行就无法使用 <code>Ctrl+C</code> 来退出：</p>&mldr;&mldr;</p><ul class=catalogue-tags><li>#<a href=/tags/Python/>Python</a></li></ul></div><div class=catalogue-item><time datetime="2022-10-25 00:00:00 +0000 UTC" class=catalogue-time>2022年10月25日</time>
<a href=https://www.fournoas.com/posts/vboxmanage-command-line-tool-for-virtualbox/ class=catalogue-title>VirtualBox 命令行管理工具——VBoxManage</a><div class=catalogue-line></div><p><p>VBoxManage 是 Oracle VM VirtualBox 的命令行管理工具。在 Windows 系统中，软件默认安装在 <code>C:\Program Files\Oracle\VirtualBox</code> 目录下。运行该命令前，可以将命令行的当前路径切换到软件安装路径：</p><pre><span class=code-lang>POWERSHELL</span><code class=language-powershell>cd &#34;C:\Program Files\Oracle\VirtualBox&#34;</code></pre><h2 id=显示所有已安装的虚拟机>显示所有已安装的虚拟机</h2><pre><span class=code-lang>POWERSHELL</span><code class=language-powershell>.\VBoxManage list vms</code></pre><p>结果如下：</p><pre><code class=language-text>&#34;Ubuntu&#34; {e16b273d-58e1-4274-8e89-f4ad5e1e3778}
&#34;FreeBSD&#34; {91bda7b4-dce2-4174-879c-e71858db3fe5}
&#34;SmartOS&#34; {279f20a0-839c-476c-b7f9-b5a40ee30eec}</code></pre><h2 id=移动虚拟机到其他路径>移动虚拟机到其他路径</h2><p>VirtualBox 的虚拟机默认安装在 <code>C:\Users\&lt;Username>\VirtualBox VMs</code> 路径下，会占用很大的硬盘空间。通过下面命令可以将虚拟机数据移动到其他路径：</p><pre><span class=code-lang>POWERSHELL</span><code class=language-powershell>.\VBoxManage.exe movevm ubuntu --folder &#34;D:\Data\VirtualBox VMs&#34;</code></pre><h2 id=打开启用嵌套-vt-xamd-v开关>打开「启用嵌套 VT-x/AMD-V」开关</h2><p>此开关在「设置-系统-处理器」选项卡中，默认置灰不可用。可以通过以下命令开启：</p>&mldr;&mldr;</p><ul class=catalogue-tags></ul></div></div><div class=pagination><a href=/posts/page/4/ class="left arrow">上一页</a>
<a href=/posts/page/6/ class="right arrow">下一页</a>
<span><sup>5</sup> &frasl; <sub>19</sub></span></div></main><script src=/js/main.js></script><footer><span>&copy; <time datetime="2024-09-19 06:37:13.118860722 +0000 UTC m=+0.745218177">2024</time> fournoas.com. Powered by <a href=https://gohugo.io>Hugo</a>.</span></footer></body></html>