<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>文章 &middot; 白汤四物</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/styles/rainbow.min.css><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/highlight.min.js crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/languages/scala.min.js crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/languages/nim.min.js crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/languages/powershell.min.js crossorigin=anonymous></script><script>hljs.initHighlightingOnLoad();</script><script src=https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js crossorigin=anonymous></script><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link href=/posts/index.xml rel=alternate type=application/rss+xml title=白汤四物><script async src="https://www.googletagmanager.com/gtag/js?id=UA-153840298-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-153840298-1');</script></head><body><nav class=nav><div class=nav-container><h1 class=nav-title><a href=/><img src=/logo.png alt=白汤四物></a></h1><ul><li><a href=/posts/><span>文章</span></a></li><li><a href=/moments/><span>动态</span></a></li><li><a href=/categories/><span>分类</span></a></li><li><a href=/tags/><span>标签</span></a></li><li><a href=/about/><span>关于</span></a></li></ul></div></nav><div class=banner><main><ul class=breadcrumb><li>文章</li></ul></main></div><main class=main><div class=catalogue><div class=catalogue-item><time datetime="2012-03-14 00:00:00 &#43;0000 UTC" class=catalogue-time>2012年3月14日</time>
<a href=https://www.fournoas.com/posts/the-giving-plague/><h1 class=catalogue-title>赐予的瘟疫</h1></a><div class=catalogue-line></div><p>作者：DAVID BRIN 一 你以为快要得到我了，是不是？来吧，你会发现我正等着你呢。 这就是为什么我的钱包里有一张伪造的卡片，上面注明我的血型是ＡＢ－，药物标签注明我对青霉素、阿斯匹林和苯氨基丙酸过敏；还注明我是一个虔诚的、身体力行的基督徒。在那必将到来的一天来早了的时候，所有这些小计谋都&hellip;&hellip;</p><ul class=catalogue-tags><li>#<a href=https://www.fournoas.com/tags/%E7%A7%91%E5%B9%BB%E5%B0%8F%E8%AF%B4/>科幻小说</a></li></ul></div><div class=catalogue-item><time datetime="2006-02-04 00:00:00 &#43;0000 UTC" class=catalogue-time>2006年2月4日</time>
<a href=https://www.fournoas.com/posts/MSN-multi-clienting-tool-source-code/><h1 class=catalogue-title>MSN 双开工具源代码</h1></a><div class=catalogue-line></div><p>网上偶然拾得本人于 2006 年所写的 <strong>MSN Messenger</strong> 双/多开工具的源代码。此即时通讯软件早于 2013 年便已停止服务，而今再看昔日所写代码不甚感慨，遂记录于此，以兹纪念&hellip;&hellip;</p><ul class=catalogue-tags><li>#<a href=https://www.fournoas.com/tags/C/C&#43;&#43;/>C/C&#43;&#43;</a></li></ul></div><div class=catalogue-item><time datetime="0001-01-01 00:00:00 &#43;0000 UTC" class=catalogue-time>0001年1月1日</time>
<a href=https://www.fournoas.com/posts/><h1 class=catalogue-title></h1></a><div class=catalogue-line></div><p>title: 汉化 foobar2000 的一种方案 date: 2022-01-29 slug: &quot;a way to localize foobar2000&quot; tags: [&quot;foobar2000&quot;] categories: [&quot;using&quot;] draft: false isCJKLanguage: true PE（Portable Executable）格式是 Windows 下可执行文件的标准格式。PE 文件中包含菜单、对话框、字符串等资源数据。汉化的原理就是使用 Resource Hacker 或 eXeScope 等 PE 文件资源编辑软件，用中文替换掉资源中的英文。
然而，foobar2000 的菜单并没有使用资源的方式保存在 PE 文件中，也未使用字符串资源。除了部分对话框资源可以用资源编辑器行汉化之外，其余诸如菜单、按钮、列表等，均无法采用上面的方法进行汉化。这些用户界面上的字符串都是以静态数据的方式保存在 .rdata 节中。现在需要定位这些 PE 文件中的静态字符串。用十六进制编辑器打开 foobar2000.exe 文件，可以看到这些字符串。但是手工定位非常繁琐，可以采用 strings 命令来简化操作。
strings 命令属于 GNU binutils 中的一个工具，可以通过 Scoop 安装：
scoop install binutils 使用 strings 获取 PE 文件中的所有静态字符串：
strings -d -t x foobar2000.exe 1c3418 File
&hellip; &hellip;
1c45b0 Exit
1c4848 Edit
1c4850 View
1c4858 Library
1c4860 Help
返回的每一行代表找到的静态字符串，每行开头的十六进制数据表示字符串在文件中的偏移量。只要把这些找到的字符串替换成中文就可以完成汉化了。
不过还有个问题，就是 foobar2000 内部采用 UTF-8 编码，而一个 UTF-8 编码的汉字要占用三个字节。也就是说，原来英文字符串所占用的长度可能容纳不下翻译后的中文。这就比较麻烦了。虽然可以通过数据重新定位等方式来进行扩容，但是要反编译软件后手工修正。如果不适用自动化工具，人力成本未免太高了。现在网上流行的汉化版 foobox-cn 似乎就是通过这种方式来实现汉化的。
另辟蹊径的方法是通过 Component 的方式将 dll 加载到 foobar2000 的进程中去，然后在运行时将软件 UI 上的文字进行中文替换。
通过 Spy++ 探测可知，foobar2000 的菜单是 ToolbarWindow32 窗口，也就是 Windows 通用控件里的工具条，通过 Win32 API CreateToolbarEx 创建 。如果能通过 API Hook 的方式，将 CreateToolbarEx 的 lpButtons 参数替换掉，就可以实现菜单的汉化了。以此类推，将所有和渲染用户界面相关的 API 都 Hook 了，就能实现软件汉化了。
这种汉化方式的优点是不需要 Patch 原来的二进制文件，可以通过 Component 的形式独立发布。&hellip;&hellip;</p></div></div><div class=pagination><a href=/posts/page/10/ class="left arrow">上一页</a>
<span><sup>11</sup> &frasl; <sub>11</sub></span></div></main><footer><span>&copy; <time datetime="2022-01-29 09:47:46.349189581 &#43;0000 UTC m=&#43;0.274856010">2022</time> fournoas.com. Powered by <a href=https://gohugo.io>Hugo</a> and <a href=https://github.com/EmielH/tale-hugo>Tale</a> theme.</span></footer><script src=/js/main.js></script></body></html>