<!doctype html><html lang=zh-CN><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Windows 资源管理器会记住用户访问过的每个文件夹的视图细节，包括视图模式、排序方式、图标大小、分组依据等。这个特性有点类似 macOS 系统里的 .DS_store 文件夹。这些文件夹的视图信息会被保存在注册表中，我们根据微软对这组注册表项的命名，将该特性称作 Shell Bags。一些 Windows 取证工具利用该特性，可以提取出用户的访问历史，包括已删除的文件夹、网络文件夹和可移动存储设备文件夹。"><title>泄露 Windows 资源管理器浏览记录的 Shell Bags &#183; 白汤四物</title>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/fontawesome.min.css crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/solid.min.css crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/regular.min.css crossorigin=anonymous referrerpolicy=no-referrer><script src=https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js crossorigin=anonymous></script><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/styles/rainbow.min.css crossorigin=anonymous referrerpolicy=no-referrer><link href rel=alternate type=application/rss+xml title=白汤四物><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-3GNL63B62Q"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3GNL63B62Q")</script></head><body><nav class=nav><div class=nav-container><h1 class=nav-title><a href=/><img src=/logo.png alt=白汤四物></a></h1><ul><li><a href=/posts/><span>文章</span></a></li><li><a href=/moments/><span>动态</span></a></li><li><a href=/categories/><span>分类</span></a></li><li><a href=/tags/><span>标签</span></a></li><li><a href=/search/><span>搜索</span></a></li><li><a href=/about/><span>关于</span></a></li></ul></div></nav><main data-pagefind-body><div class="page post"><h1 class=post-title data-pagefind-meta=title>泄露 Windows 资源管理器浏览记录的 Shell Bags</h1><div class=post-line></div><div class=post-info><span>作者</span>
<span data-pagefind-meta=作者>Fournoas
</span><span>写于&nbsp;</span><time datetime="2025-01-13 00:00:00 +0000 UTC" data-pagefind-meta=日期>2025年1月13日</time>
<span>发布在&nbsp;</span><ul class=categories><li><a data-pagefind-filter=分类 href=/categories/using/>Using</a></li></ul></div><p>Windows 资源管理器会记住用户访问过的每个文件夹的视图细节，包括视图模式、排序方式、图标大小、分组依据等。这个特性有点类似 macOS 系统里的 .DS_store 文件夹。这些文件夹的视图信息会被保存在注册表中，我们根据微软对这组注册表项的命名，将该特性称作 <strong>Shell Bags</strong>。一些 Windows 取证工具利用该特性，可以提取出用户的访问历史，包括已删除的文件夹、网络文件夹和可移动存储设备文件夹。</p><p>有两款工具可以查看系统的 Shell Bags 信息：</p><ul><li><a href=https://www.nirsoft.net/utils/shell_bags_view.html target=_blank rel=noopener>ShellBagsView</a><br><img src=/posts/shellbags-leaks-windows-explorer-browsing-history/shellbagsview.png alt=shellbagsview></li><li><a href=https://ericzimmerman.github.io/ target=_blank rel=noopener>ShellBags Explorer</a><br><img src=/posts/shellbags-leaks-windows-explorer-browsing-history/shellbagsexplorer.png alt=shellbagsexplorer></li></ul><p>其中，ShellBagsView 似乎不支持解析中文路径，而 ShellBags Explorer 的功能更强大一些。</p><p>出乎意料的是，某些主流的系统清理软件（说的就是 <a href=https://www.ccleaner.com/ target=_blank rel=noopener>CCleaner</a>）没有提供清理 Shell Bags 的功能。如果要实现手动清理 Shell Bags，那么需要先了解一下它的实现原理。</p><p>在 Windows XP 系统里，Shell Bags 数据保存在 <samp>%UserProfile%\NTUSER.dat</samp> 文件中。对应注册表以下位置：</p><ul><li>网络文件夹：HKEY_CURRENT_USER\Software\Microsoft\Windows\Shell</li><li>本地文件夹：HKEY_CURRENT_USER\Software\Microsoft\Windows\ShellNoRoam</li><li>可移动设备文件夹：HKEY_CURRENT_USER\Software\Microsoft\Windows\StreamMRU</li></ul><p>在 Windows 7 及以上系统里，数据结构发生了改变。Shell Bags 数据分别保存在 <samp>%UserProfile%\NTUSER.dat</samp> 和 <samp>%LocalAppData%\Microsoft\Windows\UsrClass.dat</samp> 文件中。分别对应注册表以下位置：</p><ul><li>网络文件夹：HKEY_CURRENT_USER\Software\Microsoft\Windows\Shell</li><li>本地文件夹：HKEY_CLASSES_ROOT\Local Settings\Software\Microsoft\Windows\Shell</li></ul><p>每个注册表分支下都包含两个子节点：</p><ul><li>BagMRU</li><li>Bags</li></ul><p>其中，BagMRU 节点下保存着资源管理器最近访问的文件夹，其子节点是一个和 Shell Namespace 保持一致的树状索引结构，并不保存文件夹视图数据。而 Bags 节点下保存着文件夹的视图数据，它的子节点是按照以 1 开始的自然数顺序创建的平坦结构。每个子节点对应着一个文件夹，节点也称为 Slot。也就是说，删除其中一个节点会导致序列不连续，取证工具是可以得知用户曾删除过数据的。</p><p>用户可以通过手动删除注册表下这两个分支来清理资源管理器的访问历史，也可以使用工具 <a href=https://privazer.com/zc/download-shellbag-analyzer-shellbag-cleaner.php target=_blank rel=noopener>Shellbag Analyzer & Cleaner</a> 进行清理。要主义的是，系统还原点会保存之前的注册表信息。因此，要彻底清除访问历史，<strong>一定要删除系统还原点数据</strong>。</p><p>为了避免留痕访问，建议使用第三方的文件管理器来替代 Windows 资源管理器。经过测试，下列第三方文件管理器不会生成 Shell Bags 数据：</p><ul><li><a href=https://apps.kde.org/dolphin/ target=_blank rel=noopener>Dolphin</a></li><li><a href=https://onecommander.com/ target=_blank rel=noopener>OneCommander</a></li></ul></div><div class=taxonomy data-pagefind-ignore><div class=taxonomy-tags><ul class=tags><li>#<a data-pagefind-filter=标签 href=/tags/Windows/>Windows</a></li></ul></div></div><div class=pagination data-pagefind-ignore><a href=/posts/ancient-and-uncommon-characters-in-wugniu/ class="left arrow">上一篇：<br>吴语中的古僻字</a>
<a href=/posts/death-of-governor-Wang-Zhao/ class="right arrow">下一篇：<br>省长王昭之死</a>
<a href=# class=top>返回顶部</a></div></main><script src=/js/page.js></script><script src=/js/main.js></script><footer><span>&copy; <time datetime="2025-01-13 10:39:15.103670155 +0000 UTC m=+1.292891421">2025</time> fournoas.com. Powered by <a href=https://gohugo.io>Hugo</a>.</span></footer></body></html>