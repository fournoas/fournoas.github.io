<!doctype html><html lang=zh-CN><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Windows 资源管理器会记住用户访问过的每个文件夹的视图细节，包括窗口大小、视图模式、排序方式、图标大小、分组依据等。这个特性有点类似 macOS 系统里的 .DS_store 文件夹。这些文件夹的视图信息会被保存在注册表中，我们根据微软对这组注册表项的命名，将该特性称作 Shell Bags。一些 Windows 取证工具利用该特性，可以提取出用户的访问历史，包括已删除的文件夹、网络文件夹和可移动存储设备文件夹。"><title>泄露 Windows 资源管理器浏览记录的 Shell Bags &#183; 白汤四物</title>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/fontawesome.min.css crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/solid.min.css crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/regular.min.css crossorigin=anonymous referrerpolicy=no-referrer><script src=https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js crossorigin=anonymous></script><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/styles/rainbow.min.css crossorigin=anonymous referrerpolicy=no-referrer><link href rel=alternate type=application/rss+xml title=白汤四物><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-3GNL63B62Q"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3GNL63B62Q")</script></head><body><nav class=nav><div class=nav-container><h1 class=nav-title><a href=/><img src=/logo.png alt=白汤四物></a></h1><ul><li><a href=/posts/><span>文章</span></a></li><li><a href=/moments/><span>动态</span></a></li><li><a href=/categories/><span>分类</span></a></li><li><a href=/tags/><span>标签</span></a></li><li><a href=/search/><span>搜索</span></a></li><li><a href=/about/><span>关于</span></a></li></ul></div></nav><main data-pagefind-body><div class="page post"><h1 class=post-title data-pagefind-meta=title>泄露 Windows 资源管理器浏览记录的 Shell Bags</h1><div class=post-line></div><div class=post-info><span>作者</span>
<span data-pagefind-meta=作者>Fournoas
</span><span>写于&nbsp;</span><time datetime="2025-01-13 00:00:00 +0000 UTC" data-pagefind-meta=日期>2025年1月13日</time>
<span>发布在&nbsp;</span><ul class=categories><li><a data-pagefind-filter=分类 href=/categories/using/>Using</a></li></ul></div><p>Windows 资源管理器会记住用户访问过的每个文件夹的视图细节，包括窗口大小、视图模式、排序方式、图标大小、分组依据等。这个特性有点类似 macOS 系统里的 .DS_store 文件夹。这些文件夹的视图信息会被保存在注册表中，我们根据微软对这组注册表项的命名，将该特性称作 <strong>Shell Bags</strong>。一些 Windows 取证工具利用该特性，可以提取出用户的访问历史，包括已删除的文件夹、网络文件夹和可移动存储设备文件夹。</p><p>有两款工具可以查看系统的 Shell Bags 信息：</p><ul><li><a href=https://www.nirsoft.net/utils/shell_bags_view.html target=_blank rel=noopener>ShellBagsView</a><br><img src=/posts/shellbags-leaks-windows-explorer-browsing-history/shellbagsview.png alt=shellbagsview></li><li><a href=https://ericzimmerman.github.io/ target=_blank rel=noopener>ShellBags Explorer</a><br><img src=/posts/shellbags-leaks-windows-explorer-browsing-history/shellbagsexplorer.png alt=shellbagsexplorer></li></ul><p>其中，ShellBagsView 似乎不支持解析中文路径，而 ShellBags Explorer 的功能更强大一些。</p><p>出乎意料的是，某些主流的系统清理软件（说的就是 <a href=https://www.ccleaner.com/ target=_blank rel=noopener>CCleaner</a>）没有提供清理 Shell Bags 的功能。如果要实现手动清理 Shell Bags，那么需要先了解一下它的实现原理。</p><p>在 Windows XP 系统里，Shell Bags 数据保存在 <samp>%UserProfile%\NTUSER.dat</samp> 文件中。对应注册表以下位置：</p><ul><li>网络文件夹：<br>HKEY_CURRENT_USER\Software\Microsoft\Windows\Shell</li><li>本地文件夹：<br>HKEY_CURRENT_USER\Software\Microsoft\Windows\ShellNoRoam</li><li>可移动设备文件夹：<br>HKEY_CURRENT_USER\Software\Microsoft\Windows\StreamMRU</li></ul><p>在之后的 Windows 系统里，数据结构发生了改变。Shell Bags 数据分别保存在 <samp>%UserProfile%\NTUSER.dat</samp> 和 <samp>%LocalAppData%\Microsoft\Windows\UsrClass.dat</samp> 文件中。分别对应注册表以下位置：</p><ul><li>网络文件夹：<br>HKEY_CURRENT_USER\Software\Microsoft\Windows\Shell</li><li>本地文件夹：<br>HKEY_CLASSES_ROOT\Local Settings\Software\Microsoft\Windows\Shell</li></ul><p>每个注册表分支下都包含两个分支：</p><ul><li>BagMRU</li><li>Bags</li></ul><figure><img src=/posts/shellbags-leaks-windows-explorer-browsing-history/regedit.png alt=regedit></figure><p>其中，Bags 分支用于记录文件夹的视图配置信息，其下的子节点按以 1 开始的整数顺序命名。这些子节点也被称为 Slot。当资源管理器首次访问一个文件夹时，便会创建一个新的节点。因此，取证工具可以通过注册表项的最后修改时间来了解用户访问文件夹的时间。此外，由于节点编号是连续的，也很容易判断用户是否删除过记录。BagMRU 分支用于记录文件夹名称和路径，其子节点是一个和 <a href=../windows-shell-folder/>Shell Namespace</a> 一致的树状结构。</p><details><summary>实现原理</summary><p>BagMRU 分支下的项可以包含以下几类键：</p><ul><li>0, 1, 2, 3 ……整数键<br>每个键对应一个子节点，亦表示一个子文件夹。其值是一个二进制数据，保存着文件夹的路径</li><li>MRUListEx<br>MRU 即 Most Recent Used。该键的值是一组 DWORD 数组，记录最近一次访问时子文件夹的顺序。每个 DWORD 表示一个子文件夹编号，以 -1 表示末尾。比如当前节点有三个子文件夹，编号为 0, 1 和 2，最近访问了编号为 2 的文件夹，则 MRUListEx 的值为 [2, 0, 1, -1]</li><li>NodeSlot<br>指向 Bags 分支下保存着视图配置信息的 Slot 节点编号</li><li>NodeSlots<br>仅出现在 BagMRU 根节点下，在创建新的 Shell Bag 时更新</li></ul><p>Bags 分支下的子项可以包含以下两种子项：</p><ul><li>Shell<br>表示数据为资源管窗口理器视图配置</li><li>ComDlg<br>表示数据为通用对话框（文件打开、保存）视图配置</li></ul></details><p>用户可以通过手动删除注册表下这两个分支来清理资源管理器的访问历史，也可以使用工具 <a href=https://privazer.com/zc/download-shellbag-analyzer-shellbag-cleaner.php target=_blank rel=noopener>Shellbag Analyzer & Cleaner</a> 进行清理。要注意的是，<strong>系统还原点会保存之前的注册表信息，要彻底清除访问历史，务必要删除所有系统还原点数据</strong>。</p><p>为了避免留痕访问，建议使用第三方的文件管理器来替代 Windows 资源管理器。经过测试，下列第三方文件管理器不会生成 Shell Bags 数据：</p><ul><li><a href=https://apps.kde.org/dolphin/ target=_blank rel=noopener>Dolphin</a></li><li><a href=https://onecommander.com/ target=_blank rel=noopener>OneCommander</a></li></ul><div class=note><div class=note-header><span class=note-title>顺带一提</span></div><div class=note-content><p>注册表 <samp>HKEY_CURRENT_USER\SOFTWARE\Classes\Local Settings\Software\Microsoft\Windows\Shell\MuiCache</samp> 下的数据会暴露用户曾使用过的应用信息，建议一并删除。</p><p><a href=https://learn.microsoft.com/zh-cn/windows/win32/intl/multilingual-user-interface target=_blank rel=noopener>MUI</a>，即 Multilingual User Interface，多语言用户接口。</p></div></div></div><div class=taxonomy data-pagefind-ignore><div class=taxonomy-tags><ul class=tags><li>#<a data-pagefind-filter=标签 href=/tags/Windows/>Windows</a></li></ul></div></div><div class=pagination data-pagefind-ignore><a href=/posts/ancient-and-uncommon-characters-in-wugniu/ class="left arrow">上一篇：<br>吴语中的古僻字</a>
<a href=/posts/death-of-governor-Wang-Zhao/ class="right arrow">下一篇：<br>省长王昭之死</a>
<a href=# class=top>返回顶部</a></div></main><script src=/js/page.js></script><script src=/js/main.js></script><footer><span>&copy; <time datetime="2025-03-12 09:32:51.87199797 +0000 UTC m=+1.083315332">2025</time> fournoas.com. Powered by <a href=https://gohugo.io>Hugo</a>.</span></footer></body></html>