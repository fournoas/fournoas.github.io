<!doctype html><html lang=zh-CN><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Windows API RegGetValueW 函数的原型如下：
c++LSTATUS RegGetValueW(
  [in]                HKEY    hkey,
  [in, optional]      LPCWSTR lpSubKey,
  [in, optional]      LPCWSTR lpValue,
  [in, optional]      DWORD   dwFlags,
  [out, optional]     LPDWORD pdwType,
  [out, optional]     PVOID   pvData,
  [in, out, optional] LPDWORD pcbData
);
使用该 API 获取字符串值时，是否传递 pvData 参数会影响 pcbData 输出的值大小。"><title>RegGetValueW 返回字符串数据大小不一致 &#183; 白汤四物</title><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/fontawesome.min.css crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/solid.min.css crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/regular.min.css crossorigin=anonymous referrerpolicy=no-referrer><script src=https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js crossorigin=anonymous></script><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/styles/rainbow.min.css crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css crossorigin=anonymous referrerpolicy=no-referrer><link href rel=alternate type=application/rss+xml title=白汤四物><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-3GNL63B62Q"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-3GNL63B62Q")</script></head><body><nav class=nav><div class=nav-container><h1 class=nav-title><a href=/><img src=/logo.png alt=白汤四物></a></h1><ul><li><a href=/posts/><span>文章</span></a></li><li><a href=/moments/><span>动态</span></a></li><li><a href=/categories/><span>分类</span></a></li><li><a href=/tags/><span>标签</span></a></li><li><a href=/search/><span>搜索</span></a></li><li><a href=/about/><span>关于</span></a></li></ul></div></nav><main data-pagefind-body><div class="page post"><h1 class=post-title data-pagefind-meta=title>RegGetValueW 返回字符串数据大小不一致</h1><div class=post-line></div><div class=post-info><span>作者</span>
<span data-pagefind-meta=作者>Fournoas
</span><span>写于&nbsp;</span><time datetime="2025-12-31 00:00:00 +0000 UTC" data-pagefind-meta=日期>2025年12月31日</time>
<span>发布在&nbsp;</span><ul class=categories><li><a data-pagefind-filter=分类 href=/categories/coding/>Coding</a></li></ul></div><p>Windows API <code>RegGetValueW</code> 函数的原型如下：</p><pre><span class=code-lang>c&#43;&#43;</span><code class=language-c++>LSTATUS RegGetValueW(
  [in]                HKEY    hkey,
  [in, optional]      LPCWSTR lpSubKey,
  [in, optional]      LPCWSTR lpValue,
  [in, optional]      DWORD   dwFlags,
  [out, optional]     LPDWORD pdwType,
  [out, optional]     PVOID   pvData,
  [in, out, optional] LPDWORD pcbData
);</code></pre><p>使用该 API 获取字符串值时，是否传递 <code>pvData</code> 参数会影响 <code>pcbData</code> 输出的值大小。</p><p>在注册表 <code>HKEY_CURRENT_USER</code> 下创建一个名为 <code>Test</code> 的字符串值，内容为 <samp>abcde</samp>。使用如下代码，分别获取字符串的字节数：</p><pre><span class=code-lang>c&#43;&#43;</span><code class=language-c++>#include &lt;iostream&gt;
#include &lt;windows.h&gt;

int main()
{
    wchar_t data[100];
    DWORD cbData = 0;

    // pvData 参数为 NULL
    if (ERROR_SUCCESS != RegGetValueW(HKEY_CURRENT_USER, 
                                      nullptr, 
                                      L&#34;Test&#34;, 
                                      RRF_RT_REG_SZ, 
                                      nullptr, 
                                      nullptr, 
                                      &amp;cbData)) {
        throw std::runtime_error(&#34;RegGetValueW failed&#34;);
    }
    std::cout &lt;&lt; &#34;Value size: &#34; &lt;&lt; cbData &lt;&lt; &#34; bytes\n&#34;;
    
    // pvData 参数不为 NULL
    if (ERROR_SUCCESS != RegGetValueW(HKEY_CURRENT_USER, 
                                      nullptr, 
                                      L&#34;Test&#34;, 
                                      RRF_RT_REG_SZ, 
                                      nullptr, 
                                      data, 
                                      &amp;cbData)) {
        throw std::runtime_error(&#34;RegGetValueW failed&#34;);
    }
    std::cout &lt;&lt; &#34;Value size: &#34; &lt;&lt; cbData &lt;&lt; &#34; bytes\n&#34;;
}</code></pre><p>输出结果为：</p><pre><code class=language-text>Value size: 14 bytes
Value size: 12 bytes</code></pre><p>当 <code>pvData</code> 参数为 <strong>NULL</strong> 时，获得的字符串数据大小是 14 字节，当 <code>pvData</code> 参数不为 <strong>NULL</strong> 时，获得的字符串数据大小是 12 字节——前者比后者多了 2 个字节，也就是一个宽字符长度。通读了一遍微软的官方文档，对此现象并没有特别说明，而各个 AI 对此的解释也是不知所云。</p><p>一种合理的推测如下：首先，注册表保存了每个字符串值占用的字节长度（含末尾 NULL 字符），但并不保证实际存储的字符串数据必然是 NULL 结尾的；其次，使用 <code>RegGetValueW</code> 获取字符串值类型的数据必须保证是 NULL 结尾的。当 <code>pvData</code> 参数为 NULL 时，<code>RegGetValueW</code> 不会扫描整个字符串，所以不确定注册表保存的字符串数据末尾是否包含 NULL 字符。为了保证 Buffer 大小能足够容纳包含结尾的 NULL，就在输出 <code>pcbData</code> 时，在保存的数据值字节长度上加上一个宽字符的长度，也就是多出来的 2 个字节。当 <code>pvData</code> 参数不为 NULL 时，<code>RegGetValueW</code> 会在复制字符串值的时候检测末尾是否为 NULL，因此得到是真实长度。</p><table><caption>注册表实际保存数据</caption><tr><td>Value</td><td>Type</td><td>Size (bytes)</td><td colspan=6>Data</td></tr><tr><td>Test</td><td>REG_SZ</td><td>12</td><td>a</td><td>b</td><td>c</td><td>d</td><td>e</td><td>\0</td></tr></table><p>为了证实猜想，用以下代码构造一个末尾不包含 NULL 字符的注册表字符串值：</p><pre><code class=language->#include &lt;iostream&gt;
#include &lt;windows.h&gt;

int main()
{
    wchar_t testData[] = L&#34;abcdefghijk&#34;;
    int cutOffLen = 5;
    
    if (ERROR_SUCCESS != RegSetValueExW(HKEY_CURRENT_USER, 
                                        L&#34;Test&#34;, 
                                        0, 
                                        REG_SZ, 
                                        (BYTE*)testData, 
                                        cutOffLen * sizeof(wchar_t))) {
        throw std::runtime_error(&#34;RegSetValueExW failed&#34;);
    }
}</code></pre><table><caption>注册表实际保存数据</caption><tr><td>Value</td><td>Type</td><td>Size (bytes)</td><td colspan=5>Data</td></tr><tr><td>Test</td><td>REG_SZ</td><td>10</td><td>a</td><td>b</td><td>c</td><td>d</td><td>e</td></tr></table><p>重新运行上一段代码，输出结果是：</p><pre><code class=language-text>Value size: 12 bytes
Value size: 12 bytes</code></pre><p>两次输出字节长度一致。Q.E.D.</p></div><div class=taxonomy data-pagefind-ignore><div class=taxonomy-tags><ul class=tags><li>#<a data-pagefind-filter=标签 href=/tags/Windows/>Windows</a></li></ul></div></div><div class=pagination data-pagefind-ignore><a href=/moments/202601/1767443979/ class="left arrow">上一篇</a>
<a href=/moments/202512/1766309288/ class="right arrow">下一篇</a>
<a href=# class=top>返回顶部</a></div></main><script src=/js/page.js></script><script src=/js/main.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/highlight.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/scala.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/nim.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/powershell.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/nginx.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/delphi.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/dos.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.10.0/languages/haxe.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://unpkg.com/highlightjs-svelte/dist/svelte.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://unpkg.com/highlightjs-zig/dist/zig.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://unpkg.com/highlightjs-redbol/dist/redbol.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=/js/code.js></script><script>hljs.highlightAll(),hljs.initLineNumbersOnLoad(),hljs.initSelectLines()</script><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js crossorigin=anonymous referrerpolicy=no-referrer onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"\\[",right:"\\]",display:!0},{left:"$$",right:"$$",display:!0},{left:"\\(",right:"\\)",display:!1}],throwOnError:!1})})</script><footer><span>&copy; <time datetime="2026-01-04 03:21:14.643187423 +0000 UTC m=+0.926693233">2026</time> fournoas.com. Powered by <a href=https://gohugo.io/>Hugo</a> v0.154.2.</span></footer></body></html>