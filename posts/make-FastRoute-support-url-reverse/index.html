<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>让 FastRoute 支持 URL 反向解析 &middot; 白汤四物</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/styles/rainbow.min.css><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/highlight.min.js crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/languages/scala.min.js crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/languages/nim.min.js crossorigin=anonymous></script><script>hljs.initHighlightingOnLoad();</script><script src=https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js crossorigin=anonymous></script><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link href rel=alternate type=application/rss+xml title=白汤四物><script async src="https://www.googletagmanager.com/gtag/js?id=UA-153840298-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-153840298-1');</script></head><body><nav class=nav><div class=nav-container><h1 class=nav-title><a href=/><img src=/logo.png alt=白汤四物></a></h1><ul><li><a href=/posts/><span>文章</span></a></li><li><a href=/moments/><span>动态</span></a></li><li><a href=/categories/><span>分类</span></a></li><li><a href=/tags/><span>标签</span></a></li><li><a href=/about/><span>关于</span></a></li></ul></div></nav><main><div class=post><h1 class=post-title>让 FastRoute 支持 URL 反向解析</h1><div class=post-line></div><div class=post-info><span>作者</span>
Fournoas
<span>于&nbsp;</span><time datetime="2019-12-17 00:00:00 &#43;0000 UTC">2019年12月17日</time>
<span>发布在</span><ul class=categories><li><a href=https://www.fournoas.com/categories/coding/>Coding</a></li></ul></div><p><a href=https://github.com/nikic/FastRoute target=_blank>FastRoute</a> 是一款高性能路由组件，需要运行于 PHP 7.1 及以上版本。很多 PHP Web 框架都用它作为默认路由。然而这款路由组件不支持 URL 反向解析。</p><p><a href=https://www.hyperf.io/ target=_blank>Hyperf</a> 框架也采用了这款路由组件，以下代码可以让 Hyperf 支持 URL 反向解析：</p><pre><code class=language-php>&lt;?php
/**
 * Router.php
**/
declare(strict_types=1);

namespace App\Http;

use Hyperf\HttpServer\Router\Router as BaseRouter;

class Router extends BaseRouter
{
    /**
     * @var array
     */
    protected static $routeMethods = ['get', 'post', 'put', 'delete', 'patch', 'head'];

    /**
     * @var string
     */
    protected static $currentGroupPrefix;

    protected static function createUrl($route)
    {
        return new Url(static::$currentGroupPrefix . $route);
    }

    public static function addGroup(string $prefix, callable $callback, array $options = [])
    {
        $previousGroupPrefix = static::$currentGroupPrefix;
        static::$currentGroupPrefix = $previousGroupPrefix . $prefix;

        $router = static::$factory-&gt;getRouter(static::$serverName);
        $router-&gt;addGroup($prefix, $callback, $options);

        static::$currentGroupPrefix = $previousGroupPrefix;
    }

    public static function addRoute($httpMethod, string $route, $handler, array $options = [])
    {
        $router = static::$factory-&gt;getRouter(static::$serverName);
        $router-&gt;addRoute($httpMethod, $route, $handler, $options);

        return static::createUrl($route);
    }

    public static function __callStatic($name, $arguments)
    {
        $returnValue = parent::__callStatic($name, $arguments);

        return in_array($name, static::$routeMethods) ? static::createUrl($arguments[0]) : $returnValue;
    }
}
</code></pre><pre><code class=language-php>&lt;?php
/**
 * Url.php
**/
declare(strict_types=1);

namespace App\Http;

use FastRoute\RouteParser\Std as RouteParser;
use LogicException;

class Url
{
    /**
     * @var string
     */
    public $route;

    /**
     * @var string
     */
    public $name;

    public function __construct(string $route)
    {
        $this-&gt;route = $route;
    }

    public function name(string $name)
    {
        $this-&gt;name = $name;
        UrlManager::getManager()-&gt;addUrl($this);

        return $this;
    }

    public function parse(...$arguments)
    {
        $routeParser = new RouteParser;
        $routes = $routeParser-&gt;parse($this-&gt;route);

        foreach ($routes as $route) {
            $parsedUrl = '';
            $i = 0;
            foreach ($route as $part) {
                if (is_string($part)) {
                    $parsedUrl .= $part;
                    continue;
                }
    
                if ($i === count($arguments)) {
                    throw new LogicException('Not enough parameters given');
                }
                $parsedUrl .= $arguments[$i++];
            }
    
            if ($i === count($arguments)) {
                return $parsedUrl;
            }
        }

        throw new LogicException(
            sprintf('The arguments does not matched for the route \'%s\'.', $this-&gt;name)
        );
    }
}
</code></pre><pre><code class=language-php>&lt;?php
/**
 * UrlManager.php
**/
declare(strict_types=1);

namespace App\Http;

use RuntimeException;

class UrlManager
{
    /**
     * @var UrlManager
     */
    protected static $manager;

    /**
     * @var array
     */
    protected $urls = [];

    public function addUrl(Url $url)
    {
        if (isset($this-&gt;urls[$url-&gt;name])) {
            throw new RuntimeException(
                sprintf('Cannot add the url named \'%s\'. A duplicate name exists.', $url-&gt;name)
            );
        }

        $this-&gt;urls[$url-&gt;name] = $url;
    }

    public function reverse(string $name, ...$arguments)
    {
        if (! isset($this-&gt;urls[$name])) {
            throw new RuntimeException(
                sprintf('The url named \'%s\' does not exists.', $name)
            );
        }

        return $this-&gt;urls[$name]-&gt;parse(...$arguments);
    }

    /**
     * @return UrlManager
     */
    public static function getManager()
    {
        if (! isset(static::$manager)) {
            static::$manager = new static();
        }

        return static::$manager;
    }
}
</code></pre><p>修改项目中的 <code>config\routes.php</code> 配置文件：</p><pre><code class=language-php>&lt;?php

declare(strict_types=1);
/**
 * This file is part of Hyperf.
 *
 * @link     https://www.hyperf.io
 * @document https://doc.hyperf.io
 * @contact  group@hyperf.io
 * @license  https://github.com/hyperf-cloud/hyperf/blob/master/LICENSE
 */

use App\Http\Router;

Router::get('/user/{id}', 'App\Controller\UserController@info')-&gt;name('user-info');
</code></pre><p>使用 URL 反向解析：</p><pre><code class=language-php>&lt;?php

use App\Http\UrlManager;

// 返回 '/user/123'
$url = UrlManager::getManager()-&gt;reverse('user-info', 123);
</code></pre></div><div class=taxonomy><div class=taxonomy-tags><ul class=tags><li>#<a href=https://www.fournoas.com/tags/PHP/>PHP</a></li></ul></div></div><div class=pagination><a href=/posts/french-onion-soup/ class="left arrow">上一篇：<br>法式洋葱汤</a>
<a href=/posts/three-hundred-Song-Ci/ class="right arrow">下一篇：<br>宋词三百首</a>
<a href=# class=top>返回顶部</a></div></main><footer><span>&copy; <time datetime="2021-10-21 10:22:29.611648492 &#43;0000 UTC m=&#43;0.434125151">2021</time> fournoas.com. Powered by <a href=https://gohugo.io>Hugo</a> and <a href=https://github.com/EmielH/tale-hugo>Tale</a> theme.</span></footer><script src=/js/main.js></script></body></html>