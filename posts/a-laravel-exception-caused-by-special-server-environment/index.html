<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>特殊的服务器环境引发的 Laravel 框架异常 &middot; 白汤四物</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/styles/rainbow.min.css><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/highlight.min.js crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/languages/scala.min.js crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/languages/nim.min.js crossorigin=anonymous></script><script>hljs.initHighlightingOnLoad();</script><script src=https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js crossorigin=anonymous></script><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link href rel=alternate type=application/rss+xml title=白汤四物><script async src="https://www.googletagmanager.com/gtag/js?id=UA-153840298-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-153840298-1');</script></head><body><nav class=nav><div class=nav-container><h1 class=nav-title><a href=/><img src=/logo.png alt=白汤四物></a></h1><ul><li><a href=/posts/><span>文章</span></a></li><li><a href=/moments/><span>动态</span></a></li><li><a href=/categories/><span>分类</span></a></li><li><a href=/tags/><span>标签</span></a></li><li><a href=/about/><span>关于</span></a></li></ul></div></nav><main><div class=post><h1 class=post-title>特殊的服务器环境引发的 Laravel 框架异常</h1><div class=post-line></div><div class=post-info><span>作者</span>
Fournoas
<span>于&nbsp;</span><time datetime="2021-12-07 00:00:00 &#43;0000 UTC">2021年12月7日</time>
<span>发布在</span><ul class=categories><li><a href=https://www.fournoas.com/categories/coding/>Coding</a></li></ul></div><p>更新生产环境代码后报错：</p><blockquote><p>ErrorException: tempnam(): file created in the system&rsquo;s temporary directory in file /foobar/vendor/laravel/framework/src/Illuminate/Filesystem/Filesystem.php on line 152</p><p>Stack trace:
1. ErrorException-&gt;() /foobar/vendor/laravel/framework/src/Illuminate/Filesystem/Filesystem.php:152
2. tempnam() /foobar/vendor/laravel/framework/src/Illuminate/Filesystem/Filesystem.php:152
3. Illuminate\Filesystem\Filesystem-&gt;replace() /foobar/vendor/laravel/framework/src/Illuminate/Foundation/ProviderRepository.php:194
4. Illuminate\Foundation\ProviderRepository-&gt;writeManifest() /foobar/vendor/laravel/framework/src/Illuminate/Foundation/ProviderRepository.php:165
5. Illuminate\Foundation\ProviderRepository-&gt;compileManifest() /foobar/vendor/laravel/framework/src/Illuminate/Foundation/ProviderRepository.php:61
6. Illuminate\Foundation\ProviderRepository-&gt;load() /foobar/vendor/laravel/framework/src/Illuminate/Foundation/Application.php:604
7. Illuminate\Foundation\Application-&gt;registerConfiguredProviders() /foobar/vendor/laravel/framework/src/Illuminate/Foundation/Bootstrap/RegisterProviders.php:17
8. Illuminate\Foundation\Bootstrap\RegisterProviders-&gt;bootstrap() /foobar/vendor/laravel/framework/src/Illuminate/Foundation/Application.php:230
9. Illuminate\Foundation\Application-&gt;bootstrapWith() /foobar/vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php:151
10. Illuminate\Foundation\Http\Kernel-&gt;bootstrap() /foobar/vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php:135
11. Illuminate\Foundation\Http\Kernel-&gt;sendRequestThroughRouter() /foobar/vendor/laravel/framework/src/Illuminate/Foundation/Http/Kernel.php:109
12. Illuminate\Foundation\Http\Kernel-&gt;handle() /foobar/public/index.php:55</p></blockquote><p>因为代码在开发环境和测试环境运行都是正常的，所以首先怀疑是生产环境服务器的配置有问题。然而 Google 搜索关键字没有人报告 Laravel 存在类似的错误。</p><p>先定位到 <em>/foobar/vendor/laravel/framework/src/Illuminate/Filesystem/Filesystem.php</em> 文件 152 行附近的代码：</p><pre><code class=language-php>/**
 * Write the contents of a file, replacing it atomically if it already exists.
 *
 * @param  string  $path
 * @param  string  $content
 * @return void
 */
public function replace($path, $content)
{
    // If the path already exists and is a symlink, get the real path...
    clearstatcache(true, $path);

    $path = realpath($path) ?: $path;

    $tempPath = tempnam(dirname($path), basename($path));

    // Fix permissions of tempPath because `tempnam()` creates it with permissions set to 0600...
    chmod($tempPath, 0777 - umask());

    file_put_contents($tempPath, $content);

    rename($tempPath, $path);
}
</code></pre><p>查看 PHP 的<a href=https://www.php.net/manual/en/function.tempnam.php target=_blank>官方文档</a>发现，如果 <code>tempnam()</code> 函数的 <code>$directory</code> 参数传递的目录不存在或者不可写入，则会在系统临时文件夹下创建临时文件：</p><blockquote><p>If the directory does not exist or is not writable, <strong>tempnam()</strong> may generate a file in the system&rsquo;s temporary directory</p></blockquote><p>并且自 7.1 版本后，如果在系统临时文件夹下创建临时文件，会触发 notice：</p><blockquote><p><strong>tempnam()</strong> now emits a notice when falling back to the temp directory of the system.</p></blockquote><p>看来是 Laravel 框架引导启动时，写入某个缓存失败导致的错误。尝试以下命令手动生成缓存：</p><pre><code class=language-bash>php artisan config:cache
</code></pre><p>得到和之前相同的错误。看来就是写入 <em>/foobar/bootstrap/cache</em> 目录时出错了，并且和用户权限没有关系。尝试在测试环境中重现该错误，将测服中的 <em>/foobar/bootstrap/cache</em> 的写入权限去除，然而却得到了不一样的错误：</p><blockquote><p>Exception: The /foobar/bootstrap/cache directory must be present and writable. in file /foobar/vendor/laravel/framework/src/Illuminate/Foundation/PackageManifest.php on line 177</p></blockquote><p>这个错误消息一目了然，非常友好，而生产环境中的错误却相当诡异。</p><p>再定位到 <em>/foobar/vendor/laravel/framework/src/Illuminate/Foundation/ProviderRepository.php</em> 文件 194 行附近的代码：</p><pre><code class=language-php>/**
 * Write the service manifest file to disk.
 *
 * @param  array  $manifest
 * @return array
 *
 * @throws \Exception
 */
public function writeManifest($manifest)
{
    if (! is_writable($dirname = dirname($this-&gt;manifestPath))) {
        throw new Exception(&quot;The {$dirname} directory must be present and writable.&quot;);
    }

    $this-&gt;files-&gt;replace(
        $this-&gt;manifestPath, '&lt;?php return '.var_export($manifest, true).';'
    );

    return array_merge(['when' =&gt; []], $manifest);
}
</code></pre><p>Laravel 框架先通过 <code>is_writable()</code> 函数判断了目标路径是否可写，然后再通过 <code>Filesystem::replace()</code> 方法写入缓存。而问题就出在 <code>is_writable()</code> 函数认为目录是可写的，返回了 <code>true</code>；而 <code>tempnam()</code> 函数认为目录不存在或者不可写，从而引起了错误异常。</p><p>因为开发人员无法接触到生产环境，排错效率很低，最终也无法定位引发错误的原因，只能将测试环境中生成的 cache 文件上传，草草了事。最后得出结论：运维傻逼！</p></div><div class=taxonomy><div class=taxonomy-tags><ul class=tags><li>#<a href=https://www.fournoas.com/tags/PHP/>PHP</a></li></ul></div></div><div class=pagination><a href=/moments/202112/1638411712/ class="left arrow">上一篇</a>
<a href=# class=top>返回顶部</a></div></main><footer><span>&copy; <time datetime="2021-12-07 20:12:53.514953056 &#43;0000 UTC m=&#43;0.140173269">2021</time> fournoas.com. Powered by <a href=https://gohugo.io>Hugo</a> and <a href=https://github.com/EmielH/tale-hugo>Tale</a> theme.</span></footer><script src=/js/main.js></script></body></html>